import React, { useState } from 'react';
import { Card, Button, Select, DatePicker, Space, Divider, Typography, Row, Col, Statistic, message, Spin } from 'antd';
import { FileTextOutlined, FilePdfOutlined, FileExcelOutlined, ProjectOutlined } from '@ant-design/icons';
import { useProject } from '../contexts/ProjectContext';
import jsPDF from 'jspdf';
import * as XLSX from 'xlsx';

const { Title, Text } = Typography;
const { RangePicker } = DatePicker;

const ReportGenerator: React.FC = () => {
  const { currentProject } = useProject();
  const [reportType, setReportType] = useState<string>('progress');
  const [dateRange, setDateRange] = useState<any>(null);
  const [isGenerating, setIsGenerating] = useState(false);

  const reportTypes = [
    { value: 'progress', label: 'ğŸ“Š é¡¹ç›®è¿›åº¦æŠ¥å‘Š', icon: <FileTextOutlined /> },
    { value: 'cost', label: 'ğŸ’° æˆæœ¬åˆ†ææŠ¥å‘Š', icon: <FileTextOutlined /> },
    { value: 'device', label: 'ğŸ”§ è®¾å¤‡é‡‡è´­æŠ¥å‘Š', icon: <FileTextOutlined /> },
    { value: 'safety', label: 'ğŸ›¡ï¸ HSEå®‰å…¨æŠ¥å‘Š', icon: <FileTextOutlined /> },
    { value: 'summary', label: 'ğŸ“ˆ é¡¹ç›®æ€»ç»“æŠ¥å‘Š', icon: <FileTextOutlined /> },
  ];

  const generatePDF = async () => {
    if (!currentProject) {
      message.warning('è¯·å…ˆé€‰æ‹©é¡¹ç›®');
      return;
    }

    setIsGenerating(true);
    message.loading('æ­£åœ¨ç”ŸæˆPDFæŠ¥å‘Š...', 0);

    setTimeout(() => {
      try {
        const pdf = new jsPDF();
        
        // æ ‡é¢˜
        pdf.setFontSize(20);
        pdf.text('EPC Project Report', 20, 20);
        
        pdf.setFontSize(12);
        pdf.text(`Project: ${currentProject.name}`, 20, 35);
        pdf.text(`Report Type: ${reportTypes.find(t => t.value === reportType)?.label || ''}`, 20, 45);
        pdf.text(`Generated: ${new Date().toLocaleString()}`, 20, 55);
        
        pdf.line(20, 60, 190, 60);
        
        // é¡¹ç›®ä¿¡æ¯
        pdf.setFontSize(14);
        pdf.text('Project Information', 20, 75);
        pdf.setFontSize(10);
        pdf.text(`Project ID: ${currentProject.id}`, 25, 85);
        pdf.text(`Status: ${currentProject.status}`, 25, 95);
        pdf.text(`Progress: ${currentProject.progress}%`, 25, 105);
        pdf.text(`Manager: ${currentProject.manager || 'N/A'}`, 25, 115);
        
        // è¿›åº¦æ¦‚è§ˆ
        pdf.setFontSize(14);
        pdf.text('Progress Overview', 20, 135);
        pdf.setFontSize(10);
        pdf.text(`Start Date: ${currentProject.start_date || 'N/A'}`, 25, 145);
        pdf.text(`End Date: ${currentProject.end_date || 'N/A'}`, 25, 155);
        pdf.text(`Budget: ${currentProject.budget ? `Â¥${currentProject.budget.toLocaleString()}` : 'N/A'}`, 25, 165);
        
        // ç»Ÿè®¡æ•°æ®
        pdf.setFontSize(14);
        pdf.text('Statistics', 20, 185);
        pdf.setFontSize(10);
        pdf.text('Tasks Completed: 23/45', 25, 195);
        pdf.text('Devices Installed: 67/89', 25, 205);
        pdf.text('Safety Inspections: 156', 25, 215);
        pdf.text('Quality Tests Passed: 234/240', 25, 225);
        
        // å¤‡æ³¨
        pdf.setFontSize(8);
        pdf.text('Generated by EPC Project Management System v2.0.0-zxx', 20, 280);
        
        pdf.save(`${currentProject.name}-${reportType}-${Date.now()}.pdf`);
        
        message.destroy();
        message.success('PDFæŠ¥å‘Šç”ŸæˆæˆåŠŸï¼');
      } catch (error) {
        message.destroy();
        message.error('PDFç”Ÿæˆå¤±è´¥');
        console.error(error);
      } finally {
        setIsGenerating(false);
      }
    }, 1500);
  };

  const generateExcel = async () => {
    if (!currentProject) {
      message.warning('è¯·å…ˆé€‰æ‹©é¡¹ç›®');
      return;
    }

    setIsGenerating(true);
    message.loading('æ­£åœ¨ç”ŸæˆExcelæŠ¥å‘Š...', 0);

    setTimeout(() => {
      try {
        const wb = XLSX.utils.book_new();
        
        // é¡¹ç›®æ¦‚è§ˆè¡¨
        const projectData = [
          ['é¡¹ç›®ä¿¡æ¯æŠ¥å‘Š'],
          [''],
          ['é¡¹ç›®åç§°', currentProject.name],
          ['é¡¹ç›®ç¼–å·', currentProject.id],
          ['é¡¹ç›®çŠ¶æ€', currentProject.status],
          ['é¡¹ç›®è¿›åº¦', `${currentProject.progress}%`],
          ['é¡¹ç›®ç»ç†', currentProject.manager || '-'],
          ['å¼€å§‹æ—¥æœŸ', currentProject.start_date || '-'],
          ['ç»“æŸæ—¥æœŸ', currentProject.end_date || '-'],
          ['é¡¹ç›®é¢„ç®—', currentProject.budget || '-'],
          [''],
          ['ç”Ÿæˆæ—¶é—´', new Date().toLocaleString()],
        ];
        const ws1 = XLSX.utils.aoa_to_sheet(projectData);
        XLSX.utils.book_append_sheet(wb, ws1, 'é¡¹ç›®æ¦‚è§ˆ');
        
        // è¿›åº¦ç»Ÿè®¡è¡¨
        const progressData = [
          ['ç±»å‹', 'å®Œæˆæ•°é‡', 'æ€»æ•°é‡', 'å®Œæˆç‡'],
          ['æ–½å·¥ä»»åŠ¡', '23', '45', '51%'],
          ['è®¾å¤‡å®‰è£…', '67', '89', '75%'],
          ['å®‰å…¨æ£€æŸ¥', '156', '160', '97%'],
          ['è´¨é‡æ£€æµ‹', '234', '240', '97%'],
        ];
        const ws2 = XLSX.utils.aoa_to_sheet(progressData);
        XLSX.utils.book_append_sheet(wb, ws2, 'è¿›åº¦ç»Ÿè®¡');
        
        // è®¾å¤‡æ¸…å•è¡¨
        const deviceData = [
          ['è®¾å¤‡åç§°', 'è§„æ ¼å‹å·', 'çŠ¶æ€', 'å®‰è£…æ—¥æœŸ', 'è´Ÿè´£äºº'],
          ['ç¦»å¿ƒæ³µP-101', 'IS80-50-200', 'å·²å®‰è£…', '2024-01-15', 'å¼ å·¥'],
          ['æ¢çƒ­å™¨E-201', 'BEM400-1.6-200-4/25', 'å¾…å®‰è£…', '-', 'æå·¥'],
          ['ååº”é‡œR-301', 'GSH-5000', 'å·²å®‰è£…', '2024-02-20', 'ç‹å·¥'],
          ['å‹ç¼©æœºC-401', 'L-40/8', 'è¿è¾“ä¸­', '-', 'èµµå·¥'],
        ];
        const ws3 = XLSX.utils.aoa_to_sheet(deviceData);
        XLSX.utils.book_append_sheet(wb, ws3, 'è®¾å¤‡æ¸…å•');
        
        XLSX.writeFile(wb, `${currentProject.name}-${reportType}-${Date.now()}.xlsx`);
        
        message.destroy();
        message.success('ExcelæŠ¥å‘Šç”ŸæˆæˆåŠŸï¼');
      } catch (error) {
        message.destroy();
        message.error('Excelç”Ÿæˆå¤±è´¥');
        console.error(error);
      } finally {
        setIsGenerating(false);
      }
    }, 1500);
  };

  return (
    <div>
      <Title level={2}>
        <FileTextOutlined /> é¡¹ç›®æŠ¥è¡¨ç”Ÿæˆ
      </Title>
      <Text type="secondary">å¿«é€Ÿç”Ÿæˆå„ç±»é¡¹ç›®æŠ¥è¡¨ï¼Œæ”¯æŒPDFå’ŒExcelæ ¼å¼å¯¼å‡º</Text>

      <Divider />

      {!currentProject ? (
        <Card>
          <Space direction="vertical" align="center" style={{ width: '100%', padding: 40 }}>
            <ProjectOutlined style={{ fontSize: 48, color: '#ccc' }} />
            <Text type="secondary">è¯·å…ˆåœ¨é¡µé¢é¡¶éƒ¨é€‰æ‹©ä¸€ä¸ªé¡¹ç›®</Text>
          </Space>
        </Card>
      ) : (
        <>
          <Row gutter={[16, 16]}>
            <Col span={24}>
              <Card title="å½“å‰é¡¹ç›®" variant="borderless">
                <Row gutter={16}>
                  <Col span={6}>
                    <Statistic title="é¡¹ç›®åç§°" value={currentProject.name} valueStyle={{ fontSize: 16 }} />
                  </Col>
                  <Col span={6}>
                    <Statistic title="é¡¹ç›®è¿›åº¦" value={currentProject.progress} suffix="%" />
                  </Col>
                  <Col span={6}>
                    <Statistic title="é¡¹ç›®çŠ¶æ€" value={currentProject.status} valueStyle={{ fontSize: 16 }} />
                  </Col>
                  <Col span={6}>
                    <Statistic 
                      title="é¡¹ç›®é¢„ç®—" 
                      value={currentProject.budget || 0} 
                      prefix="Â¥"
                      precision={0}
                    />
                  </Col>
                </Row>
              </Card>
            </Col>

            <Col span={24}>
              <Card title="æŠ¥è¡¨é…ç½®" variant="borderless">
                <Space direction="vertical" size="large" style={{ width: '100%' }}>
                  <div>
                    <Text strong>æŠ¥è¡¨ç±»å‹</Text>
                    <Select
                      value={reportType}
                      onChange={setReportType}
                      style={{ width: '100%', marginTop: 8 }}
                      size="large"
                      options={reportTypes}
                    />
                  </div>

                  <div>
                    <Text strong>æ—¶é—´èŒƒå›´ï¼ˆå¯é€‰ï¼‰</Text>
                    <RangePicker
                      value={dateRange}
                      onChange={setDateRange}
                      style={{ width: '100%', marginTop: 8 }}
                      size="large"
                    />
                  </div>
                </Space>
              </Card>
            </Col>

            <Col span={24}>
              <Card title="å¯¼å‡ºæŠ¥è¡¨" variant="borderless">
                <Spin spinning={isGenerating}>
                  <Space size="large" style={{ width: '100%', justifyContent: 'center', padding: 20 }}>
                    <Button
                      type="primary"
                      size="large"
                      icon={<FilePdfOutlined />}
                      onClick={generatePDF}
                      disabled={isGenerating}
                      style={{ width: 200, height: 80, fontSize: 16 }}
                    >
                      ç”ŸæˆPDFæŠ¥å‘Š
                    </Button>
                    <Button
                      type="primary"
                      size="large"
                      icon={<FileExcelOutlined />}
                      onClick={generateExcel}
                      disabled={isGenerating}
                      style={{ width: 200, height: 80, fontSize: 16, background: '#52c41a', borderColor: '#52c41a' }}
                    >
                      ç”ŸæˆExcelæŠ¥å‘Š
                    </Button>
                  </Space>
                </Spin>
              </Card>
            </Col>
          </Row>
        </>
      )}
    </div>
  );
};

export default ReportGenerator;


