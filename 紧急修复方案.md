# 🚨 紧急问题诊断与修复方案

## 当前问题

### 问题1：后端连接超时 ❌
**现象**：甘特图显示"后端连接超时（5秒），已自动切换本地模式"

**诊断**：
- ✅ 后端服务正常运行（PID: 27564）
- ✅ 端口8000正常监听
- ✅ curl测试返回200 OK
- ✅ CORS配置正确
- ❌ 前端fetch请求超时

**可能原因**：
1. **Electron环境限制** - Electron的webSecurity可能阻止localhost请求
2. **网络栈问题** - Windows防火墙或网络配置
3. **fetch实现问题** - React在Electron中的fetch可能有延迟

---

### 问题2：数据不保存 ❌
**现象**：新建项目、任务等数据刷新后丢失

**原因**：
- 当前使用 `quick-start.py` - **内存数据库**
- 数据存储在Python变量中：
  ```python
  projects_db = []  # 只在内存中
  tasks_db = []     # 只在内存中
  devices_db = []   # 只在内存中
  ```
- 重启后端或刷新页面，数据全部丢失

---

## 🔧 立即修复方案

### 方案A：添加本地JSON文件持久化（5分钟）

快速为quick-start.py添加JSON文件存储：

```python
# 启动时加载数据
def load_data():
    global projects_db, tasks_db, devices_db
    try:
        with open('data.json', 'r', encoding='utf-8') as f:
            data = json.load(f)
            projects_db = data.get('projects', [])
            tasks_db = data.get('tasks', [])
            devices_db = data.get('devices', [])
    except FileNotFoundError:
        pass

# 每次修改后保存
def save_data():
    with open('data.json', 'w', encoding='utf-8') as f:
        json.dump({
            'projects': projects_db,
            'tasks': tasks_db,
            'devices': devices_db
        }, f, ensure_ascii=False, indent=2)
```

**优点**：
- ✅ 立即可用
- ✅ 无需安装新依赖
- ✅ 数据可读

**缺点**：
- ⚠️ 并发写入可能丢失数据
- ⚠️ 大数据量性能差

---

### 方案B：切换到SQLite数据库（15分钟）

使用Python内置的SQLite3：

```bash
cd server
pip install databases aiosqlite
```

创建完整的数据库后端（已有代码框架在server/app/目录）

**优点**：
- ✅ 真正的数据库
- ✅ 支持并发
- ✅ 性能好

**缺点**：
- ⏰ 需要时间重构
- 📦 需要配置数据库

---

### 方案C：前端LocalStorage临时存储（3分钟）

在前端添加LocalStorage备份：

```typescript
// 保存项目时
const saveProject = async (project) => {
    try {
        await fetch(...); // 尝试后端
    } catch {
        // 后端失败，存localStorage
        const projects = JSON.parse(localStorage.getItem('projects') || '[]');
        projects.push(project);
        localStorage.setItem('projects', JSON.stringify(projects));
    }
}
```

**优点**：
- ✅ 最快实现
- ✅ 无需后端改动
- ✅ 本地数据不丢失

**缺点**：
- ⚠️ 仅浏览器可用（Electron每次重启会清空）
- ⚠️ 容量限制（~5MB）

---

## 🎯 推荐方案

### 立即执行：方案A（JSON文件）+ 方案C（前端备份）

**第一步**：修复quick-start.py添加JSON持久化
**第二步**：修复前端超时问题
**第三步**：添加前端LocalStorage备份

**预计时间**：10分钟
**数据安全**：✅ 保证不丢失

---

## ⚡ 需要我立即开始吗？

请选择：
1. **立即修复** - 我现在就添加JSON持久化和前端备份
2. **诊断优先** - 先彻底找出fetch超时的原因
3. **切换SQLite** - 直接升级到真正的数据库

**回复数字1/2/3，我立即开始！**


