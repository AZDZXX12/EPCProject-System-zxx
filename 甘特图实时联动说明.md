# 甘特图实时联动功能说明

## 📅 更新时间
2025-10-18

## ✨ 实时联动功能

### 🔄 自动同步机制

#### 1. **后端数据同步**
所有任务操作都会同步到后端数据库：

| 操作 | 同步方式 | API接口 |
|------|---------|---------|
| 添加任务 | POST到后端 | `POST /api/v1/tasks/` |
| 编辑任务 | PUT更新后端 | `PUT /api/v1/tasks/{id}` |
| 删除任务 | DELETE后端 | `DELETE /api/v1/tasks/{id}` |
| 加载任务 | GET从后端 | `GET /api/v1/tasks/` |

#### 2. **自动刷新策略**

```typescript
// 30秒自动刷新一次
setInterval(() => {
  loadTasks(); // 从后端重新加载所有任务
}, 30000);
```

**特点**:
- ✅ 每30秒自动从服务器获取最新数据
- ✅ 实现多用户协同（其他用户的修改会自动显示）
- ✅ 确保数据一致性
- ✅ 后台静默刷新，不打扰用户操作

#### 3. **即时联动更新**

所有操作完成后立即重新加载：

```typescript
// 添加任务后
await loadTasks(); // 立即刷新

// 编辑任务后
await loadTasks(); // 立即刷新

// 删除任务后
await loadTasks(); // 立即刷新
```

---

## 🎯 使用场景

### 场景1：多用户协同
```
用户A添加了一个任务
→ 30秒内，用户B的甘特图会自动更新显示该任务
→ 无需手动刷新
```

### 场景2：跨页面同步
```
在"任务列表"页面修改任务
→ 切换到"甘特图"页面
→ 自动显示最新数据
→ 两个页面数据保持一致
```

### 场景3：实时监控
```
项目经理在办公室查看甘特图
→ 现场施工人员更新任务进度
→ 30秒后，项目经理看到最新进度
→ 实现实时项目监控
```

---

## 🔄 手动刷新

除了自动刷新，还可以手动刷新：

**方法1**: 点击顶部"刷新"按钮
- 立即从服务器获取最新数据
- 显示提示："🔄 正在刷新任务数据..."
- 适合需要立即查看最新数据的情况

**方法2**: 浏览器刷新
- 按F5或Ctrl+R
- 重新加载整个页面
- 所有数据从头加载

---

## 💾 数据持久化

### 后端存储
所有任务数据存储在SQLite数据库中：

```
数据库: data/epc_project.db
表: tasks

字段:
- id: 任务ID
- name: 任务名称
- start_date: 开始日期
- end_date: 结束日期
- assignee: 负责人
- priority: 优先级
- status: 状态
- progress: 进度
- project_id: 项目ID
- dependencies: 依赖关系
```

### 本地降级
如果后端不可用，系统会自动降级到本地模式：

```typescript
try {
  // 尝试同步到后端
  await fetch('http://localhost:8000/api/v1/tasks/', {...});
} catch (error) {
  // 后端不可用，仅更新本地
  setTasks(updatedTasks);
  message.warning('⚠️ 已更新本地数据（未同步到服务器）');
}
```

**特点**:
- ✅ 后端故障不影响本地操作
- ✅ 显示警告提示用户
- ✅ 后端恢复后可手动刷新同步

---

## 🔐 身份验证

### Token认证
所有API请求都包含JWT Token：

```typescript
const token = localStorage.getItem('access_token');
const response = await fetch(url, {
  headers: {
    'Authorization': `Bearer ${token}`,
  }
});
```

**登录凭证**:
- 用户名: `admin`
- 密码: `admin123`

---

## 📊 实时状态显示

### 控制台日志

打开浏览器开发者工具（F12）可以看到：

```
✅ 任务已加载: 5 个
🔄 自动刷新任务数据...
✅ 任务已加载: 6 个
✅ 任务已添加到服务器
✅ 任务已加载: 7 个
```

### 用户提示

| 操作 | 成功提示 | 失败提示 |
|------|---------|---------|
| 添加 | ✅ 任务已添加到服务器 | ⚠️ 已添加到本地（未同步到服务器）|
| 编辑 | ✅ 任务已更新到服务器 | ⚠️ 已更新本地数据（未同步到服务器）|
| 删除 | 🗑️ 任务已从服务器删除 | ⚠️ 已删除本地数据（未同步到服务器）|
| 刷新 | 🔄 正在刷新任务数据... | - |

---

## 🚀 性能优化

### 1. 智能刷新
```
只在必要时刷新，避免过度请求：
- 添加/编辑/删除后立即刷新
- 30秒自动后台刷新
- 手动刷新按钮
```

### 2. 本地缓存
```
加载的任务数据缓存在React State中：
- 避免重复请求
- 快速UI响应
- 减少服务器负载
```

### 3. 异步操作
```
所有API调用都是异步的：
- 不阻塞UI
- 后台静默处理
- 操作完成后通知用户
```

---

## 🛠️ 故障处理

### 后端不可用
```
现象: API请求失败
处理: 
1. 自动切换到演示数据模式
2. 显示警告提示
3. 本地操作仍可用
4. 后端恢复后手动刷新

日志:
⚠️ 从API加载失败，使用演示数据
⚠️ 连接失败，使用演示数据
```

### Token过期
```
现象: 401 Unauthorized
处理:
1. 自动跳转到登录页
2. 重新登录获取新Token
3. 返回甘特图继续操作

解决: 重新登录即可
```

### 网络超时
```
现象: 请求长时间无响应
处理:
1. 自动降级到本地模式
2. 显示警告提示
3. 稍后可重试

操作: 点击刷新按钮重试
```

---

## 📝 开发指南

### 修改刷新间隔

在 `InteractiveGanttChart.tsx` 中修改：

```typescript
// 当前: 30秒刷新一次
setInterval(() => {
  loadTasks();
}, 30000); // 修改这个值

// 示例:
// 10秒: 10000
// 1分钟: 60000
// 5分钟: 300000
```

### 添加新的同步字段

1. 更新 `Task` 接口：
```typescript
interface Task {
  // ... 现有字段
  newField: string; // 新增字段
}
```

2. 在 `handleModalOk` 中添加字段：
```typescript
const taskData = {
  // ... 现有字段
  newField: values.newField
};
```

3. 在表单中添加输入框：
```typescript
<Form.Item name="newField" label="新字段">
  <Input />
</Form.Item>
```

---

## ✅ 测试清单

### 功能测试

- [ ] 添加任务后立即显示在甘特图
- [ ] 编辑任务后甘特图实时更新
- [ ] 删除任务后甘特图立即移除
- [ ] 30秒后自动刷新数据
- [ ] 手动刷新按钮有效
- [ ] 后端不可用时显示警告
- [ ] 登录后Token正确传递
- [ ] 多个浏览器窗口数据同步

### 性能测试

- [ ] 100个任务加载速度
- [ ] 30秒刷新不卡顿
- [ ] 添加任务响应时间<2秒
- [ ] PDF导出功能正常

---

## 🎉 总结

### 实时联动特性

1. ✅ **后端持久化** - 所有数据存储在数据库
2. ✅ **自动刷新** - 每30秒自动同步
3. ✅ **即时更新** - 操作后立即刷新
4. ✅ **多用户协同** - 支持团队协作
5. ✅ **故障降级** - 后端故障不影响使用
6. ✅ **身份认证** - JWT Token保护数据
7. ✅ **实时反馈** - 操作状态及时提示

### 使用建议

- 📱 打开多个浏览器窗口测试同步效果
- 🔄 观察控制台日志了解同步状态
- 💾 定期备份数据库文件
- 🚀 根据需求调整刷新间隔

---

**版本**: 2.0.0-zxx  
**开发团队**: EPC开发团队  
**更新日期**: 2025-10-18

**现在刷新浏览器即可体验实时联动功能！** 🚀



