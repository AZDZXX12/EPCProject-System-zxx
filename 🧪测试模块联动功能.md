# 🧪 EPC系统模块联动功能测试指南

## 测试前准备

1. **确保系统已启动**:
   ```bash
   # 后端
   cd server
   python sqlite-server.py
   
   # 前端
   cd client
   npm start
   ```

2. **清空旧数据**（可选）:
   - 按F12打开浏览器控制台
   - 输入: `localStorage.clear()`
   - 刷新页面

---

## 测试场景1: 甘特图 → 施工日志联动

### 步骤
1. 登录系统，进入 **工作台**
2. 选择或创建一个项目（如"化工设备生产线安装项目"）
3. 进入 **甘特图** 模块
4. 拖动任意任务的进度条，将进度从 50% 拖到 80%
5. 打开浏览器控制台（F12），查看事件日志

### 预期结果 ✅
```
[EventBus] 触发事件: task:updated
[DataManager] 任务更新联动: {id: "PROJ-001-TASK-2", progress: 80}
[DataManager] 项目进度计算: {taskProgress: 65, phaseProgress: 45, logProgress: 40, finalProgress: 52}
[EventBus] 触发事件: progress:changed {projectId: "PROJ-001", progress: 52}
```

- ✅ 控制台显示事件触发日志
- ✅ 页面右上角显示通知："项目进度已更新: 52% (来源: 任务进度)"
- ✅ 工作台的项目列表中，进度条自动更新为 52%

---

## 测试场景2: 施工日志 → 甘特图联动

### 步骤
1. 进入 **施工日志** 模块
2. 点击"添加日志"按钮
3. 填写表单:
   - 施工日期: 今天
   - 任务名称: "主体结构施工"
   - 任务ID: `PROJ-001-TASK-3`（假设甘特图中存在此任务）
   - 天气: 晴
   - 温度: 20-28℃
   - 作业人数: 50
   - 工作内容: "完成基础混凝土浇筑"
   - 当日进度: **90**
   - 报告人: 张三
4. 点击"确定"

### 预期结果 ✅
```
[EventBus] 触发事件: log:created
[Gantt] 任务进度已同步: {taskId: "PROJ-001-TASK-3", progress: 90}
[EventBus] 触发事件: task:updated
[EventBus] 触发事件: progress:changed
```

- ✅ 控制台显示日志创建事件
- ✅ 页面显示通知："任务进度已同步: 主体结构施工 进度: 90%"
- ✅ 切换到甘特图，任务 "PROJ-001-TASK-3" 的进度已自动更新为 90%
- ✅ 工作台的项目进度已重新计算

---

## 测试场景3: 总包施工管理 → 项目进度联动

### 步骤
1. 进入 **总包施工管理** 模块
2. 找到"采购阶段 (Procurement)"卡片
3. 点击"编辑"按钮
4. 修改进度: 从 100% 改为 **85%**
5. 修改负责人: 李经理 → 王经理
6. 点击"保存"

### 预期结果 ✅
```
[EventBus] 触发事件: phase:updated
[DataManager] 阶段更新联动: {key: "procurement", progress: 85}
[DataManager] 项目进度计算: {...}
[EventBus] 触发事件: progress:changed
[Workspace] 项目进度已更新
```

- ✅ 控制台显示阶段更新事件
- ✅ 页面显示通知："阶段信息已更新，项目进度已同步"
- ✅ 工作台的项目进度自动重新计算并更新
- ✅ 数据已保存到 LocalStorage: `epc_phases_PROJ-001`

---

## 测试场景4: 数据持久化验证

### 步骤
1. 执行上述任意操作（如更新甘特图任务）
2. 打开浏览器控制台（F12）
3. 查看 LocalStorage:
   ```javascript
   // 查看甘特图任务缓存
   JSON.parse(localStorage.getItem('epc_gantt_tasks_PROJ-001'))
   
   // 查看施工日志
   JSON.parse(localStorage.getItem('epc_construction_logs'))
   
   // 查看EPC阶段数据
   JSON.parse(localStorage.getItem('epc_epc_phases_PROJ-001'))
   
   // 查看存储统计
   console.table(JSON.parse(localStorage.getItem('epc_storage_stats')))
   ```
4. **刷新页面**
5. 验证数据是否保留

### 预期结果 ✅
- ✅ LocalStorage 中有对应的数据项
- ✅ 数据格式正确，包含 `value`, `timestamp`, `ttl` 字段
- ✅ 刷新后数据仍然存在
- ✅ 甘特图、施工日志等模块显示之前的数据

---

## 测试场景5: 项目切换隔离验证

### 步骤
1. 在工作台创建两个项目:
   - 项目A: "化工设备生产线"
   - 项目B: "石油炼化装置改造"
2. 选择项目A，进入甘特图，添加任务"任务A1"
3. 选择项目B，进入甘特图，添加任务"任务B1"
4. 切换回项目A，验证是否只显示"任务A1"
5. 进入施工日志，为项目A添加日志
6. 切换到项目B，验证是否看不到项目A的日志

### 预期结果 ✅
- ✅ 项目A的甘特图只显示"任务A1"
- ✅ 项目B的甘特图只显示"任务B1"
- ✅ 项目A的施工日志只显示项目A的数据
- ✅ 项目B的施工日志只显示项目B的数据
- ✅ 控制台显示: `[Gantt] 项目切换，清空数据和颜色映射`
- ✅ 数据完全隔离，互不干扰

---

## 测试场景6: 进度计算准确性验证

### 步骤
1. 选择项目A
2. 设置各数据源进度:
   - 甘特图: 添加3个任务，进度分别为 60%, 80%, 100%
   - EPC阶段: 
     - 设计阶段: 100%（权重15%）
     - 采购阶段: 80%（权重20%）
     - 施工阶段: 50%（权重40%）
     - 调试阶段: 0%（权重15%）
     - 验收阶段: 0%（权重10%）
   - 施工日志: 添加3条日志，进度分别为 70%, 75%, 80%
3. 打开控制台，查看计算日志

### 预期结果 ✅

**手动计算**:
```
甘特图任务平均进度 = (60 + 80 + 100) / 3 = 80%
EPC阶段加权进度 = 100*0.15 + 80*0.20 + 50*0.40 + 0*0.15 + 0*0.10 
                 = 15 + 16 + 20 = 51%
施工日志平均进度 = (70 + 75 + 80) / 3 = 75%

项目总进度 = 80 * 0.4 + 51 * 0.4 + 75 * 0.2
          = 32 + 20.4 + 15
          = 67.4%
          ≈ 67%
```

**控制台日志**:
```
[DataManager] 项目进度计算: {
  projectId: "PROJ-001",
  taskProgress: 80,
  phaseProgress: 51,
  logProgress: 75,
  finalProgress: 67
}
```

- ✅ 计算结果与手动计算一致
- ✅ 工作台显示进度为 67%
- ✅ 进度条颜色正确（67% 应为橙色/进行中）

---

## 测试场景7: 事件防抖验证

### 步骤
1. 进入甘特图
2. **快速连续**拖动同一个任务的进度条（模拟抖动）
3. 观察控制台事件触发次数
4. 观察通知提示数量

### 预期结果 ✅
- ✅ 虽然拖动多次，但进度计算事件只触发一次（防抖生效）
- ✅ 通知提示只显示一次，不会重复弹出
- ✅ 控制台日志清晰，无重复计算

---

## 测试场景8: 错误处理验证

### 步骤
1. 断开后端服务（关闭 `python sqlite-server.py`）
2. 进入甘特图，尝试加载数据
3. 进入施工日志，尝试保存数据
4. 观察系统行为

### 预期结果 ✅
- ✅ 甘特图自动切换到本地模拟数据
- ✅ 控制台显示: `[Gantt] 无法连接后端，使用本地模拟数据`
- ✅ 施工日志数据保存到 LocalStorage
- ✅ 页面不崩溃，功能基本可用
- ✅ 显示友好的提示信息

---

## 测试场景9: 性能压力测试

### 步骤
1. 进入甘特图
2. **快速**添加 50 个任务
3. **快速**更新这些任务的进度
4. 观察页面响应速度
5. 打开浏览器性能分析工具（F12 → Performance）
6. 录制操作过程

### 预期结果 ✅
- ✅ 页面不卡顿，响应流畅
- ✅ 每次进度更新 < 500ms
- ✅ 内存占用稳定，无泄漏
- ✅ CPU占用合理（< 30%）
- ✅ 事件总线处理效率高

---

## 调试技巧

### 1. 查看事件统计
```javascript
// 在控制台输入
eventBus.getStats()

// 输出示例:
[
  { event: 'task:updated', listeners: 2 },
  { event: 'log:created', listeners: 1 },
  { event: 'progress:changed', listeners: 3 }
]
```

### 2. 查看存储统计
```javascript
// 在控制台输入
StorageManager.getStats()

// 输出示例:
{
  totalItems: 8,
  totalSize: 45678,
  items: [
    { key: 'gantt_tasks_PROJ-001', size: 15234, age: 3600000 },
    { key: 'construction_logs', size: 8765, age: 1800000 },
    ...
  ]
}
```

### 3. 手动触发事件（测试）
```javascript
// 在控制台输入
eventBus.emit('task:updated', {
  id: 'TEST-TASK-1',
  projectId: 'PROJ-001',
  name: '测试任务',
  progress: 90
});
```

### 4. 清理过期数据
```javascript
// 在控制台输入
StorageManager.cleanup()

// 输出: 清理过期数据完成，共删除 3 项
```

---

## 常见问题排查

### Q1: 进度没有更新？
**检查**:
1. 是否选择了当前项目？
2. 控制台是否有错误？
3. 事件是否正确触发？（查看 `eventBus.getStats()`）
4. 后端是否运行？

### Q2: 数据丢失？
**检查**:
1. LocalStorage 是否被清空？
2. 浏览器隐私模式可能不保存数据
3. 查看 `StorageManager.getStats()` 是否有数据

### Q3: 模块不联动？
**检查**:
1. 是否在同一个项目下操作？
2. 事件监听器是否正确注册？（查看 `eventBus.getStats()`）
3. 控制台是否有事件触发日志？

### Q4: 性能卡顿？
**检查**:
1. 是否有过多任务/日志？（建议 < 100 条）
2. 是否有内存泄漏？（查看浏览器内存分析）
3. 是否开启了开发模式的调试日志？（会影响性能）

---

## 测试报告模板

```markdown
# 模块联动功能测试报告

## 测试环境
- 浏览器: Chrome 120
- 操作系统: Windows 11
- 测试日期: 2025-01-XX

## 测试结果

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 场景1: 甘特图 → 施工日志 | ✅ 通过 | 联动正常，通知及时 |
| 场景2: 施工日志 → 甘特图 | ✅ 通过 | 进度同步准确 |
| 场景3: 总包管理 → 项目进度 | ✅ 通过 | 进度计算正确 |
| 场景4: 数据持久化 | ✅ 通过 | 刷新后数据保留 |
| 场景5: 项目切换隔离 | ✅ 通过 | 数据完全隔离 |
| 场景6: 进度计算准确性 | ✅ 通过 | 计算结果准确 |
| 场景7: 事件防抖 | ✅ 通过 | 防抖生效 |
| 场景8: 错误处理 | ✅ 通过 | 降级策略正常 |
| 场景9: 性能压力 | ✅ 通过 | 响应流畅，无卡顿 |

## 发现的问题
1. 无

## 总体评价
模块联动功能运行稳定，各项指标符合预期。
```

---

**测试完成后，请将结果反馈给开发团队！** 🎉





## 测试前准备

1. **确保系统已启动**:
   ```bash
   # 后端
   cd server
   python sqlite-server.py
   
   # 前端
   cd client
   npm start
   ```

2. **清空旧数据**（可选）:
   - 按F12打开浏览器控制台
   - 输入: `localStorage.clear()`
   - 刷新页面

---

## 测试场景1: 甘特图 → 施工日志联动

### 步骤
1. 登录系统，进入 **工作台**
2. 选择或创建一个项目（如"化工设备生产线安装项目"）
3. 进入 **甘特图** 模块
4. 拖动任意任务的进度条，将进度从 50% 拖到 80%
5. 打开浏览器控制台（F12），查看事件日志

### 预期结果 ✅
```
[EventBus] 触发事件: task:updated
[DataManager] 任务更新联动: {id: "PROJ-001-TASK-2", progress: 80}
[DataManager] 项目进度计算: {taskProgress: 65, phaseProgress: 45, logProgress: 40, finalProgress: 52}
[EventBus] 触发事件: progress:changed {projectId: "PROJ-001", progress: 52}
```

- ✅ 控制台显示事件触发日志
- ✅ 页面右上角显示通知："项目进度已更新: 52% (来源: 任务进度)"
- ✅ 工作台的项目列表中，进度条自动更新为 52%

---

## 测试场景2: 施工日志 → 甘特图联动

### 步骤
1. 进入 **施工日志** 模块
2. 点击"添加日志"按钮
3. 填写表单:
   - 施工日期: 今天
   - 任务名称: "主体结构施工"
   - 任务ID: `PROJ-001-TASK-3`（假设甘特图中存在此任务）
   - 天气: 晴
   - 温度: 20-28℃
   - 作业人数: 50
   - 工作内容: "完成基础混凝土浇筑"
   - 当日进度: **90**
   - 报告人: 张三
4. 点击"确定"

### 预期结果 ✅
```
[EventBus] 触发事件: log:created
[Gantt] 任务进度已同步: {taskId: "PROJ-001-TASK-3", progress: 90}
[EventBus] 触发事件: task:updated
[EventBus] 触发事件: progress:changed
```

- ✅ 控制台显示日志创建事件
- ✅ 页面显示通知："任务进度已同步: 主体结构施工 进度: 90%"
- ✅ 切换到甘特图，任务 "PROJ-001-TASK-3" 的进度已自动更新为 90%
- ✅ 工作台的项目进度已重新计算

---

## 测试场景3: 总包施工管理 → 项目进度联动

### 步骤
1. 进入 **总包施工管理** 模块
2. 找到"采购阶段 (Procurement)"卡片
3. 点击"编辑"按钮
4. 修改进度: 从 100% 改为 **85%**
5. 修改负责人: 李经理 → 王经理
6. 点击"保存"

### 预期结果 ✅
```
[EventBus] 触发事件: phase:updated
[DataManager] 阶段更新联动: {key: "procurement", progress: 85}
[DataManager] 项目进度计算: {...}
[EventBus] 触发事件: progress:changed
[Workspace] 项目进度已更新
```

- ✅ 控制台显示阶段更新事件
- ✅ 页面显示通知："阶段信息已更新，项目进度已同步"
- ✅ 工作台的项目进度自动重新计算并更新
- ✅ 数据已保存到 LocalStorage: `epc_phases_PROJ-001`

---

## 测试场景4: 数据持久化验证

### 步骤
1. 执行上述任意操作（如更新甘特图任务）
2. 打开浏览器控制台（F12）
3. 查看 LocalStorage:
   ```javascript
   // 查看甘特图任务缓存
   JSON.parse(localStorage.getItem('epc_gantt_tasks_PROJ-001'))
   
   // 查看施工日志
   JSON.parse(localStorage.getItem('epc_construction_logs'))
   
   // 查看EPC阶段数据
   JSON.parse(localStorage.getItem('epc_epc_phases_PROJ-001'))
   
   // 查看存储统计
   console.table(JSON.parse(localStorage.getItem('epc_storage_stats')))
   ```
4. **刷新页面**
5. 验证数据是否保留

### 预期结果 ✅
- ✅ LocalStorage 中有对应的数据项
- ✅ 数据格式正确，包含 `value`, `timestamp`, `ttl` 字段
- ✅ 刷新后数据仍然存在
- ✅ 甘特图、施工日志等模块显示之前的数据

---

## 测试场景5: 项目切换隔离验证

### 步骤
1. 在工作台创建两个项目:
   - 项目A: "化工设备生产线"
   - 项目B: "石油炼化装置改造"
2. 选择项目A，进入甘特图，添加任务"任务A1"
3. 选择项目B，进入甘特图，添加任务"任务B1"
4. 切换回项目A，验证是否只显示"任务A1"
5. 进入施工日志，为项目A添加日志
6. 切换到项目B，验证是否看不到项目A的日志

### 预期结果 ✅
- ✅ 项目A的甘特图只显示"任务A1"
- ✅ 项目B的甘特图只显示"任务B1"
- ✅ 项目A的施工日志只显示项目A的数据
- ✅ 项目B的施工日志只显示项目B的数据
- ✅ 控制台显示: `[Gantt] 项目切换，清空数据和颜色映射`
- ✅ 数据完全隔离，互不干扰

---

## 测试场景6: 进度计算准确性验证

### 步骤
1. 选择项目A
2. 设置各数据源进度:
   - 甘特图: 添加3个任务，进度分别为 60%, 80%, 100%
   - EPC阶段: 
     - 设计阶段: 100%（权重15%）
     - 采购阶段: 80%（权重20%）
     - 施工阶段: 50%（权重40%）
     - 调试阶段: 0%（权重15%）
     - 验收阶段: 0%（权重10%）
   - 施工日志: 添加3条日志，进度分别为 70%, 75%, 80%
3. 打开控制台，查看计算日志

### 预期结果 ✅

**手动计算**:
```
甘特图任务平均进度 = (60 + 80 + 100) / 3 = 80%
EPC阶段加权进度 = 100*0.15 + 80*0.20 + 50*0.40 + 0*0.15 + 0*0.10 
                 = 15 + 16 + 20 = 51%
施工日志平均进度 = (70 + 75 + 80) / 3 = 75%

项目总进度 = 80 * 0.4 + 51 * 0.4 + 75 * 0.2
          = 32 + 20.4 + 15
          = 67.4%
          ≈ 67%
```

**控制台日志**:
```
[DataManager] 项目进度计算: {
  projectId: "PROJ-001",
  taskProgress: 80,
  phaseProgress: 51,
  logProgress: 75,
  finalProgress: 67
}
```

- ✅ 计算结果与手动计算一致
- ✅ 工作台显示进度为 67%
- ✅ 进度条颜色正确（67% 应为橙色/进行中）

---

## 测试场景7: 事件防抖验证

### 步骤
1. 进入甘特图
2. **快速连续**拖动同一个任务的进度条（模拟抖动）
3. 观察控制台事件触发次数
4. 观察通知提示数量

### 预期结果 ✅
- ✅ 虽然拖动多次，但进度计算事件只触发一次（防抖生效）
- ✅ 通知提示只显示一次，不会重复弹出
- ✅ 控制台日志清晰，无重复计算

---

## 测试场景8: 错误处理验证

### 步骤
1. 断开后端服务（关闭 `python sqlite-server.py`）
2. 进入甘特图，尝试加载数据
3. 进入施工日志，尝试保存数据
4. 观察系统行为

### 预期结果 ✅
- ✅ 甘特图自动切换到本地模拟数据
- ✅ 控制台显示: `[Gantt] 无法连接后端，使用本地模拟数据`
- ✅ 施工日志数据保存到 LocalStorage
- ✅ 页面不崩溃，功能基本可用
- ✅ 显示友好的提示信息

---

## 测试场景9: 性能压力测试

### 步骤
1. 进入甘特图
2. **快速**添加 50 个任务
3. **快速**更新这些任务的进度
4. 观察页面响应速度
5. 打开浏览器性能分析工具（F12 → Performance）
6. 录制操作过程

### 预期结果 ✅
- ✅ 页面不卡顿，响应流畅
- ✅ 每次进度更新 < 500ms
- ✅ 内存占用稳定，无泄漏
- ✅ CPU占用合理（< 30%）
- ✅ 事件总线处理效率高

---

## 调试技巧

### 1. 查看事件统计
```javascript
// 在控制台输入
eventBus.getStats()

// 输出示例:
[
  { event: 'task:updated', listeners: 2 },
  { event: 'log:created', listeners: 1 },
  { event: 'progress:changed', listeners: 3 }
]
```

### 2. 查看存储统计
```javascript
// 在控制台输入
StorageManager.getStats()

// 输出示例:
{
  totalItems: 8,
  totalSize: 45678,
  items: [
    { key: 'gantt_tasks_PROJ-001', size: 15234, age: 3600000 },
    { key: 'construction_logs', size: 8765, age: 1800000 },
    ...
  ]
}
```

### 3. 手动触发事件（测试）
```javascript
// 在控制台输入
eventBus.emit('task:updated', {
  id: 'TEST-TASK-1',
  projectId: 'PROJ-001',
  name: '测试任务',
  progress: 90
});
```

### 4. 清理过期数据
```javascript
// 在控制台输入
StorageManager.cleanup()

// 输出: 清理过期数据完成，共删除 3 项
```

---

## 常见问题排查

### Q1: 进度没有更新？
**检查**:
1. 是否选择了当前项目？
2. 控制台是否有错误？
3. 事件是否正确触发？（查看 `eventBus.getStats()`）
4. 后端是否运行？

### Q2: 数据丢失？
**检查**:
1. LocalStorage 是否被清空？
2. 浏览器隐私模式可能不保存数据
3. 查看 `StorageManager.getStats()` 是否有数据

### Q3: 模块不联动？
**检查**:
1. 是否在同一个项目下操作？
2. 事件监听器是否正确注册？（查看 `eventBus.getStats()`）
3. 控制台是否有事件触发日志？

### Q4: 性能卡顿？
**检查**:
1. 是否有过多任务/日志？（建议 < 100 条）
2. 是否有内存泄漏？（查看浏览器内存分析）
3. 是否开启了开发模式的调试日志？（会影响性能）

---

## 测试报告模板

```markdown
# 模块联动功能测试报告

## 测试环境
- 浏览器: Chrome 120
- 操作系统: Windows 11
- 测试日期: 2025-01-XX

## 测试结果

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 场景1: 甘特图 → 施工日志 | ✅ 通过 | 联动正常，通知及时 |
| 场景2: 施工日志 → 甘特图 | ✅ 通过 | 进度同步准确 |
| 场景3: 总包管理 → 项目进度 | ✅ 通过 | 进度计算正确 |
| 场景4: 数据持久化 | ✅ 通过 | 刷新后数据保留 |
| 场景5: 项目切换隔离 | ✅ 通过 | 数据完全隔离 |
| 场景6: 进度计算准确性 | ✅ 通过 | 计算结果准确 |
| 场景7: 事件防抖 | ✅ 通过 | 防抖生效 |
| 场景8: 错误处理 | ✅ 通过 | 降级策略正常 |
| 场景9: 性能压力 | ✅ 通过 | 响应流畅，无卡顿 |

## 发现的问题
1. 无

## 总体评价
模块联动功能运行稳定，各项指标符合预期。
```

---

**测试完成后，请将结果反馈给开发团队！** 🎉




