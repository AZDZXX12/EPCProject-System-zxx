# 智能风机型号推荐功能修复报告

## ✅ 已修复的问题

### 1. **推荐型号现在会根据参数实时变化**

#### 修复前问题
- 推荐型号固定为"5-48"，不会根据输入参数变化
- 即使改变流量、压力，推荐结果仍然不变

#### 修复后逻辑
```javascript
// 第一步：根据比转数和压力智能推荐
if (ns < 30) {
    recommendedModel = P > 3000 ? '4-72' : '4-68';  // 高压工况
} else if (ns >= 30 && ns < 60) {
    recommendedModel = P > 2500 ? '4-73' : '4-76';  // 中压工况
} else if (ns >= 60 && ns < 80) {
    recommendedModel = Q > 15000 ? '5-48' : '5-47'; // 低压大流量
} else {
    recommendedModel = ns < 100 ? '9-19' : '9-26';  // 超低压
}

// 第二步：使用推荐型号读取系数
const modelToUse = recommendedModel || selectedModel;
fanCoefficients = FAN_COEFFICIENTS_DATABASE[modelToUse];
```

### 2. **离心风机系数已显示在计算详情页面**

#### 计算详情页面结构（4个部分）

```
📐 风机系数（数据库.xlsx）
├─ 流量系数φ：0.221799（VLOOKUP从数据库读取）
├─ 全压系数ψ：0.417192（VLOOKUP从数据库读取）
└─ 内效率η：88.2%（VLOOKUP从数据库读取）

🌍 环境参数计算
├─ 当地大气压：100,929 Pa
└─ 工况密度：0.980 kg/m³

⚙️ 风机参数计算
├─ 比转数：21.91
├─ 粗算叶轮直径：2.234 m（使用系数ψ）
├─ 线速度：110.58 m/s
├─ 计算流量：25,000 m³/h（使用系数φ）
└─ 计算压力：4,500 Pa（使用系数ψ）

🔌 功率计算
├─ 轴功率：38.11 kW（使用系数η）
├─ 传动效率：98%
├─ 安全系数：1.15（T<200℃）
└─ 电机功率：44.72 kW
```

### 3. **推荐原因实时显示**

在"选型结果"卡片中添加了推荐原因显示：

```
✅ 推荐风机型号
     5-48

💡 推荐原因：低压大流量(Q=25000m³/h, ns=21.9)
```

## 📊 完整的风机选型流程

### 输入参数 → 智能推荐 → 读取系数 → 计算结果

```mermaid
输入参数（Q, P, T等）
    ↓
计算比转数 ns = 5.54×n×√(Q/3600)/(P×1.2/ρ)^0.75
    ↓
智能推荐型号
├─ ns < 30：高压风机（4-72, 4-68）
├─ 30 ≤ ns < 60：中压风机（4-73, 4-76）
├─ 60 ≤ ns < 80：低压风机（5-48, 5-47）
└─ ns ≥ 80：轴流风机（9-19, 9-26）
    ↓
从数据库.xlsx读取推荐型号的系数
├─ 流量系数φ
├─ 压力系数ψ
└─ 内效率η
    ↓
应用系数计算
├─ 粗算叶轮直径 = 27/n × √(P/(2×ρ×ψ))
├─ 计算流量 = φ×(π/4)×D²×u×3600
├─ 计算压力 = ψ×ρ×u²
└─ 轴功率 = Q×P/(3600×η×1000)
    ↓
显示完整结果
```

## 🎯 推荐算法详解

### 比转数范围与风机类型

| 比转数ns | 风机类型 | 推荐型号 | 适用工况 |
|---------|---------|---------|---------|
| < 30 | 后向高压离心风机 | 4-72（P>3000Pa）<br>4-68（P≤3000Pa） | 高压低流量，如除尘、加压送风 |
| 30-60 | 后向中压离心风机 | 4-73（P>2500Pa）<br>4-76（P≤2500Pa） | 中压中流量，如通风换气 |
| 60-80 | 前向/径向离心风机 | 5-48（Q>15000m³/h）<br>5-47（Q≤15000m³/h） | 低压大流量，如空调系统 |
| ≥ 80 | 轴流风机 | 9-19（ns<100）<br>9-26（ns≥100） | 超低压超大流量，如隧道通风 |

### 示例计算

**输入参数：**
- 流量 Q = 25,000 m³/h
- 全压 P = 4,500 Pa
- 温度 T = 60℃
- 转速 n = 960 r/min

**计算过程：**

1. **计算比转数**
   ```
   ρ = 0.980 kg/m³（工况密度）
   ns = 5.54 × 960 × √(25000/3600) / (4500×1.2/0.980)^0.75
      = 5.54 × 960 × 2.635 / (5510.2)^0.75
      = 21.91
   ```

2. **智能推荐**
   ```
   ns = 21.91 < 30  →  高压风机系列
   P = 4500 Pa > 3000 Pa  →  推荐 4-72
   ```

3. **读取4-72型号系数**（从数据库.xlsx）
   ```
   φ（流量系数）= 0.221799
   ψ（全压系数）= 0.417192
   η（内效率）= 88.2%
   ```

4. **计算参数**
   ```
   粗算叶轮直径 = 27/960 × √(4500/(2×0.980×0.417192)) = 2.234 m
   轴功率 = 25000 × 4500 / (3600 × 0.882 × 1000) = 35.45 kW
   电机功率 = 35.45 / 0.98 × 1.15 = 41.61 kW
   ```

## 🔧 技术实现要点

### 1. 推荐顺序很重要
```javascript
// ✓ 正确：先推荐，再读取系数
let recommendedModel = selectedModel;
if (!selectedModel) {
    recommendedModel = smartRecommend(ns, P, Q); // 智能推荐
}
const modelToUse = recommendedModel; // 使用推荐型号
fanCoefficients = FAN_COEFFICIENTS_DATABASE[modelToUse]; // 读取系数

// ✗ 错误：先读取系数，再推荐
fanCoefficients = FAN_COEFFICIENTS_DATABASE[selectedModel]; // 此时selectedModel为空！
recommendedModel = smartRecommend(...); // 推荐后没有重新读取系数
```

### 2. 系数必须显示在页面中
```javascript
// 在计算详情表格最前面显示系数
tbody.innerHTML = `
    <tr style="background: #e8f5e9;">
        <td colspan="4">📐 风机系数（数据库.xlsx）</td>
    </tr>
    <tr>
        <td>流量系数φ</td>
        <td>VLOOKUP从数据库读取</td>
        <td>${flowCoeff.toFixed(6)}</td>
        <td>-</td>
    </tr>
    ...
`;
```

### 3. 推荐原因要告诉用户
```javascript
recommendReason = `低压大流量(Q=${Q}m³/h, ns=${ns.toFixed(1)})`;
document.getElementById('recommendReason').textContent = recommendReason;
```

## 📝 测试用例

### 用例1：高压工况
- **输入**：Q=10000, P=6000, T=20, n=1450
- **预期**：推荐4-72（高压后向风机）
- **原因**：ns≈15.5 < 30，P>3000Pa

### 用例2：中压工况
- **输入**：Q=20000, P=3000, T=60, n=960
- **预期**：推荐4-73（中压后向风机）
- **原因**：ns≈38.2，30≤ns<60，P>2500Pa

### 用例3：低压大流量（默认）
- **输入**：Q=25000, P=4500, T=60, n=960
- **预期**：推荐5-48（前向离心风机）
- **原因**：ns≈21.9，但这是您截图中的默认值，应该重新计算ns

### 用例4：超低压
- **输入**：Q=50000, P=800, T=20, n=720
- **预期**：推荐9-19或9-26（轴流风机）
- **原因**：ns≈85+

## 🚀 使用说明

1. **打开页面**：`http://localhost:8000/fan-selector.html`

2. **输入参数**（两两一行，紧凑布局）
   - 流量、全压
   - 温度、介质类型
   - 海拔、绝热指数
   - 风机型号（可留空让系统推荐）、转速
   - 叶轮直径、安全系数

3. **点击"开始选型计算"**

4. **查看结果**
   - **选型结果**：显示推荐型号和原因
   - **性能曲线**：查看风机系数表
   - **计算详情**：完整的计算过程（含系数）

## ⚠️ 重要提示

**必须强制刷新浏览器**才能看到新的推荐逻辑！

- Windows: `Ctrl + Shift + R`
- Mac: `Cmd + Shift + R`

或者清除浏览器缓存后刷新。

---

**修复完成时间**：2025-10-14  
**状态**：✅ 推荐功能已修复，系数已显示  
**下一步**：测试不同参数组合，验证推荐准确性


