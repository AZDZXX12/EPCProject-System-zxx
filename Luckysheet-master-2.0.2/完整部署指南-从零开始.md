# 🚀 Luckysheet 选型系统 - 完整部署指南（从零到上线）

> **状态更新**：✅ 代码已成功推送到 GitHub  
> **仓库地址**：https://github.com/azdzxx/luckysheet-selection-system

---

## 📋 目录

1. [概述](#概述)
2. [第一步：GitHub仓库（已完成）](#第一步github仓库已完成)
3. [第二步：部署后端到Render](#第二步部署后端到render)
4. [第三步：部署前端到Vercel](#第三步部署前端到vercel)
5. [第四步：连接前后端](#第四步连接前后端)
6. [第五步：测试验证](#第五步测试验证)
7. [常见问题解决](#常见问题解决)

---

## 概述

### 部署架构

```
用户浏览器
    ↓
Vercel（前端静态文件）
    ↓ API请求
Render（后端Django API）
    ↓
PostgreSQL（数据库）
```

### 时间估算

- ✅ GitHub推送：已完成
- ⏱️ Render后端：10分钟
- ⏱️ Vercel前端：3分钟
- ⏱️ 前后端连接：5分钟
- **总计：约18分钟**

### 成本

- 💰 **完全免费**（$0/月）

---

## 第一步：GitHub仓库（已完成）

✅ **状态**：已完成

✅ **仓库地址**：https://github.com/azdzxx/luckysheet-selection-system

✅ **已提交**：280个文件，169,352行代码

**无需任何操作，继续下一步。**

---

## 第二步：部署后端到Render

### 2.1 注册Render账号（2分钟）

1. **访问Render官网**
   ```
   https://render.com
   ```

2. **注册账号**
   - 点击右上角 **"Get Started"** 或 **"Sign Up"**
   - 推荐：点击 **"Sign up with GitHub"**（最方便）
   - 授权Render访问你的GitHub账号
   - 完成注册

3. **验证邮箱**（如果需要）

---

### 2.2 创建PostgreSQL数据库（3分钟）

1. **创建数据库**
   - 登录Render控制台
   - 点击左侧或顶部的 **"New +"** 按钮
   - 选择 **"PostgreSQL"**

2. **配置数据库**
   
   | 字段 | 值 | 说明 |
   |------|-----|------|
   | **Name** | `cable-selector-db` | 数据库名称（可自定义） |
   | **Database** | `cable_selector` | 数据库实例名 |
   | **User** | `cable_selector_user` | 数据库用户名 |
   | **Region** | `Oregon` 或 `Singapore` | 选择离你最近的区域 |
   | **PostgreSQL Version** | 默认最新版 | 保持默认 |
   | **Plan** | **Free** ⭐ | 选择免费计划 |

3. **创建并等待**
   - 点击 **"Create Database"** 按钮
   - 等待1-2分钟，数据库创建中...
   - 创建完成后，状态显示为 "Available"

4. **复制数据库连接URL** ⚠️ 重要！
   - 在数据库详情页面，找到 **"Connections"** 部分
   - 复制 **"Internal Database URL"**（重要！）
   - 它看起来像这样：
     ```
     postgresql://cable_selector_user:密码@主机:5432/cable_selector
     ```
   - **保存这个URL**，下一步需要用到！

   > 💡 提示：点击URL旁边的复制图标可以一键复制

---

### 2.3 创建Web Service（5分钟）

1. **开始创建**
   - 回到Render控制台首页
   - 点击 **"New +"** 按钮
   - 选择 **"Web Service"**

2. **连接GitHub仓库**
   - 如果是第一次，点击 **"Connect account"**
   - 选择 **"GitHub"** 并授权
   - 在仓库列表中找到：`azdzxx/luckysheet-selection-system`
   - 点击 **"Connect"** 按钮

3. **配置Web Service** ⚠️ 关键步骤

   | 字段 | 值 | 说明 |
   |------|-----|------|
   | **Name** | `cable-selector-backend` | 服务名称（可自定义） |
   | **Region** | `Oregon` 或 `Singapore` | 与数据库相同区域 |
   | **Branch** | `main` | 分支名称（必须是main） |
   | **Root Directory** | `xuanxing/backend` | ⚠️ **重要**：必须精确填写 |
   | **Runtime** | `Python 3` | 选择Python运行环境 |
   | **Build Command** | 见下方 | 构建命令 |
   | **Start Command** | 见下方 | 启动命令 |
   | **Plan** | **Free** ⭐ | 选择免费计划 |

   **Build Command**（复制粘贴）：
   ```bash
   pip install -r requirements.txt && python manage.py collectstatic --no-input && python manage.py migrate && python manage.py load_initial_data
   ```

   **Start Command**（复制粘贴）：
   ```bash
   gunicorn cable_selector.wsgi:application
   ```

4. **添加环境变量** ⚠️ 重要配置
   
   向下滚动到 **"Environment Variables"** 部分，点击 **"Add Environment Variable"**，添加以下变量：

   | Key | Value | 说明 |
   |-----|-------|------|
   | `SECRET_KEY` | 点击"Generate"自动生成 | Django密钥 |
   | `DEBUG` | `False` | 生产环境关闭调试 |
   | `DATABASE_URL` | 粘贴步骤2.2复制的URL | 数据库连接 |
   | `ALLOWED_HOSTS` | 暂时留空 | 部署后填写 |
   | `CORS_ALLOWED_ORIGINS` | 暂时留空 | 前端部署后填写 |
   | `PYTHON_VERSION` | `3.11` | 指定Python版本（可选） |

   > 💡 提示：`SECRET_KEY` 可以点击输入框右侧的 "Generate" 按钮自动生成

5. **创建服务**
   - 检查所有配置是否正确
   - 特别检查 **Root Directory** 是否为 `xuanxing/backend`
   - 点击底部的 **"Create Web Service"** 按钮

6. **等待部署**
   - 部署开始，可以看到实时日志
   - 预计需要3-5分钟
   - 观察日志输出，确认没有错误

7. **部署成功标志**
   
   日志中会显示：
   ```
   ✓ Installing dependencies...
   ✓ Running collectstatic...
   ✓ Running migrations...
   ✓ Loading initial data...
   ✓ Starting gunicorn...
   ==> Server is running on port 10000
   ```

8. **记录后端URL**
   - 部署成功后，在页面顶部可以看到你的服务URL
   - 例如：`https://cable-selector-backend.onrender.com`
   - **记下这个URL**，后面需要用到

---

### 2.4 更新ALLOWED_HOSTS（1分钟）

1. **获取服务域名**
   - 复制你的Render服务URL（去掉 `https://`）
   - 例如：`cable-selector-backend.onrender.com`

2. **更新环境变量**
   - 点击 **"Environment"** 标签
   - 找到 `ALLOWED_HOSTS` 变量
   - 点击编辑（铅笔图标）
   - 填入域名：`cable-selector-backend.onrender.com`
   - 点击 **"Save Changes"**

3. **等待重新部署**
   - Render会自动重新部署（约1分钟）
   - 等待完成

---

### 2.5 测试后端API（1分钟）

1. **访问API端点**
   ```
   https://你的服务名.onrender.com/api/cables/
   ```
   
   例如：
   ```
   https://cable-selector-backend.onrender.com/api/cables/
   ```

2. **验证响应**
   
   **成功**：看到JSON数据列表
   ```json
   [
     {
       "id": 1,
       "type": "YJV-0.6/1kV",
       "cross_section": 1.5,
       "current_rating": 22,
       ...
     },
     ...
   ]
   ```

   **失败**：看到错误页面
   - 查看 Render 的 "Logs" 标签
   - 参考本文档末尾的 "常见问题解决"

---

## 第三步：部署前端到Vercel

### 3.1 注册Vercel账号（1分钟）

1. **访问Vercel官网**
   ```
   https://vercel.com
   ```

2. **注册账号**
   - 点击 **"Sign Up"**
   - 推荐：点击 **"Continue with GitHub"**（最方便）
   - 授权Vercel访问你的GitHub
   - 完成注册

---

### 3.2 导入并部署项目（2分钟）

1. **导入项目**
   - 登录Vercel控制台
   - 点击 **"Add New..."** → **"Project"**
   - 或直接点击 **"Add New Project"**

2. **选择仓库**
   - 点击 **"Import Git Repository"**
   - 在列表中找到：`azdzxx/luckysheet-selection-system`
   - 点击 **"Import"** 按钮

3. **配置项目** ⚠️ 关键设置

   | 字段 | 值 | 说明 |
   |------|-----|------|
   | **Project Name** | `luckysheet-selection-system` | 项目名称（会成为域名） |
   | **Framework Preset** | `Other` | 选择"Other"或"None" |
   | **Root Directory** | `./` 或留空 | 使用根目录 |
   | **Build Command** | 留空 | 不需要构建 |
   | **Output Directory** | `dist-refactored` | ⚠️ **重要**：静态文件目录 |
   | **Install Command** | 留空 | 不需要安装依赖 |

   > ⚠️ **关键**：`Output Directory` 必须填写 `dist-refactored`

4. **环境变量**
   - 对于此项目，不需要添加环境变量
   - 直接跳过

5. **开始部署**
   - 检查配置，特别是 `Output Directory`
   - 点击 **"Deploy"** 按钮
   - 等待部署（约1-2分钟）

6. **部署成功**
   - 看到庆祝动画 🎉
   - 显示你的网站URL

7. **记录前端URL**
   - 例如：`https://luckysheet-selection-system.vercel.app`
   - **记下这个URL**，下一步需要用到

---

### 3.3 测试前端（1分钟）

1. **访问网站**
   ```
   https://你的项目名.vercel.app
   ```

2. **验证功能**
   
   以下功能应该正常工作：
   - ✅ 页面加载正常
   - ✅ 看到 "设备参数选型系统" 标题
   - ✅ 工具栏按钮显示
   - ✅ 可以点击 "新建" 创建表格
   - ✅ 离心风机选型按钮可点击

   > 💡 电缆选型功能需要后端API，在第四步连接后才能使用

---

## 第四步：连接前后端

### 4.1 更新后端CORS配置（2分钟）

1. **登录Render**
   - 进入你的后端服务（cable-selector-backend）

2. **配置CORS**
   - 点击 **"Environment"** 标签
   - 找到 `CORS_ALLOWED_ORIGINS` 变量
   - 点击编辑或添加
   - 填入你的Vercel前端URL（完整URL，包括https://）：
     ```
     https://luckysheet-selection-system.vercel.app
     ```
   - 如果有多个域名，用逗号分隔：
     ```
     https://域名1.vercel.app,https://域名2.vercel.app
     ```

3. **保存并重新部署**
   - 点击 **"Save Changes"**
   - 等待自动重新部署（约1分钟）

---

### 4.2 更新前端API地址（3分钟，仅电缆选型需要）

> ⚠️ **注意**：此步骤仅在需要使用电缆选型功能时执行。  
> 离心风机选型、Excel编辑等功能不需要后端，已经可以正常使用。

**方式A：修改代码并重新部署**（推荐）

1. **在本地项目中找到文件**
   ```
   dist-refactored/cable-selector/assets/index-*.js
   ```
   
   实际文件可能是：
   - `index-5f75c207.js`
   - `index-94078c68.js`

2. **编辑文件**
   - 用代码编辑器打开
   - 搜索 `localhost:8000`
   - 找到类似这样的代码：
     ```javascript
     const API_URL = 'http://localhost:8000/api';
     ```
   
3. **替换为Render后端地址**
   ```javascript
   const API_URL = 'https://cable-selector-backend.onrender.com/api';
   ```
   
   > 💡 替换为你的实际后端URL

4. **提交并推送**
   ```bash
   git add .
   git commit -m "更新API地址为Render后端"
   git push
   ```

5. **Vercel自动部署**
   - Vercel会检测到GitHub更新
   - 自动触发重新部署（约1分钟）
   - 在Vercel控制台可以看到部署进度

**方式B：使用环境变量**（高级）

如果你熟悉前端构建，可以修改代码使用环境变量，然后在Vercel添加环境变量。此处不详细展开。

---

## 第五步：测试验证

### 5.1 测试前端功能

访问你的Vercel网站：`https://你的项目名.vercel.app`

**测试清单**：

| 功能 | 测试方法 | 预期结果 |
|------|---------|---------|
| **主页加载** | 直接访问首页 | ✅ 页面正常显示 |
| **Excel编辑** | 点击"打开"上传Excel | ✅ 可以编辑表格 |
| **离心风机选型** | 点击"🌀离心风机选型" | ✅ 打开选型页面，可以计算 |
| **电缆选型** | 点击"⚡电缆选型" | ✅ 打开选型页面（需要后端） |
| **PDF导出** | 点击"导出PDF" | ✅ 生成PDF预览 |

---

### 5.2 测试电缆选型（后端API）

1. **打开电缆选型页面**
   - 点击工具栏的 **"⚡ 电缆选型"** 按钮

2. **输入测试参数**
   ```
   电压：380V
   电流：100A
   长度：50m
   环境温度：30℃
   敷设方式：桥架
   ```

3. **点击"计算"按钮**

4. **验证结果**
   
   **成功**：
   - ✅ 显示推荐的电缆规格
   - ✅ 显示载流量、电压降等参数
   - ✅ 可以看到3D电缆模型

   **失败**：
   - ❌ 按F12打开浏览器控制台
   - 查看Network标签中的请求
   - 检查是否有CORS错误
   - 参考下方"常见问题解决"

---

### 5.3 记录部署信息

| 项目 | URL/信息 |
|------|----------|
| **GitHub仓库** | https://github.com/azdzxx/luckysheet-selection-system |
| **前端（Vercel）** | https://________________________.vercel.app |
| **后端（Render）** | https://________________________.onrender.com |
| **数据库** | postgresql://________________________ |

---

## 常见问题解决

### ❌ 问题1：Render部署失败 "Root Directory not found"

**错误信息**：
```
lstat /opt/render/project/src/xuanxing/backend: no such file or directory
```

**原因**：Root Directory 配置不正确

**解决方案**：
1. 进入Render服务的 Settings 标签
2. 找到 "Root Directory"
3. 确保填写的是：`xuanxing/backend`（注意格式）
   - ✅ 正确：`xuanxing/backend`
   - ❌ 错误：`/xuanxing/backend`
   - ❌ 错误：`xuanxing/backend/`
   - ❌ 错误：`xuanxing\backend`
4. 保存并等待重新部署

---

### ❌ 问题2：Vercel部署成功但显示404

**原因**：Output Directory 配置不正确

**解决方案**：
1. 进入Vercel项目的 Settings
2. 找到 "Build & Development Settings"
3. 确保 "Output Directory" 设置为：`dist-refactored`
4. 保存并重新部署

---

### ❌ 问题3：电缆选型提示CORS错误

**错误信息**（浏览器控制台）：
```
Access to fetch at 'https://xxx.onrender.com/api/...' from origin 'https://xxx.vercel.app' 
has been blocked by CORS policy
```

**原因**：后端CORS配置未包含前端域名

**解决方案**：
1. 登录Render，进入后端服务
2. Environment 标签
3. 找到 `CORS_ALLOWED_ORIGINS`
4. 确保包含你的Vercel域名（完整URL）：
   ```
   https://luckysheet-selection-system.vercel.app
   ```
5. 保存并等待重新部署
6. 清除浏览器缓存并刷新页面

---

### ❌ 问题4：后端API访问很慢（首次加载）

**现象**：首次访问后端API需要等待5-10秒

**原因**：Render免费服务15分钟无活动后会休眠

**解决方案**：
1. **临时方案**：每次使用前先访问一次后端URL唤醒
2. **长期方案**：使用UptimeRobot监控（免费）
   - 访问 https://uptimerobot.com
   - 注册账号
   - 添加监控：`https://你的后端.onrender.com/api/cables/`
   - 监控间隔：5分钟
   - 这样后端会保持活跃

---

### ❌ 问题5：数据库连接失败

**错误信息**（Render日志）：
```
django.db.utils.OperationalError: could not connect to server
```

**原因**：DATABASE_URL 配置错误

**解决方案**：
1. 回到Render数据库页面
2. 复制 "Internal Database URL"（完整URL）
3. 回到Web Service的Environment标签
4. 更新 `DATABASE_URL` 变量
5. 确保复制完整，包括 `postgresql://` 开头
6. 保存并重新部署

---

### ❌ 问题6：Build Command执行失败

**错误信息**：
```
ERROR: Could not find a version that satisfies the requirement...
```

**原因**：Python版本不兼容

**解决方案**：
1. 在Environment中添加变量：
   - Key: `PYTHON_VERSION`
   - Value: `3.11`
2. 或修改 `requirements.txt`，固定版本号
3. 保存并重新部署

---

## 🎉 部署完成！

恭喜！你的 Luckysheet 选型系统现已成功部署！

### ✅ 你现在拥有：
- 🌍 全球可访问的Web应用
- 🔒 免费HTTPS加密
- ⚡ 全球CDN加速
- 🔄 自动部署（推送代码即更新）
- 💰 完全免费（$0/月）

### 📊 功能清单：
- ✅ Excel设备参数选型表编辑
- ✅ 离心风机选型计算
- ✅ 电缆选型（IEC标准）
- ✅ Word文档编辑器
- ✅ PDF导出功能
- ✅ 数据库管理

### 🎯 下一步优化（可选）：

1. **防止后端休眠**（强烈推荐）
   - 使用 UptimeRobot 每5分钟ping后端
   - 网址：https://uptimerobot.com

2. **定期备份数据库**
   - Render免费数据库90天后删除
   - 需要定期导出备份

3. **自定义域名**（可选）
   - Vercel和Render都支持免费自定义域名
   - 在各自的Settings中配置

4. **性能监控**（可选）
   - Vercel Analytics（免费）
   - Sentry错误追踪（免费tier）

---

## 📞 需要帮助？

- 📖 查看详细文档：`部署指南.md`
- 🔧 查看优化建议：`部署成功后的优化建议.md`
- 📋 使用检查清单：`部署检查清单.md`

---

**祝你使用愉快！** 🚀

**分享你的链接，让更多人使用你的应用！**

