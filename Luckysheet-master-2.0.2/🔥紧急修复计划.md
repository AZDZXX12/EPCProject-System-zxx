# 🔥 紧急修复计划 - 根据用户反馈

## 📋 用户反馈的问题（全部需要修复）

### 1. 时间差8小时 ❌
**问题**：历史记录保存时间比实际时间晚8小时  
**原因**：后端可能保存UTC时间，前端未正确转换  
**修复**：后端保存时使用本地时间，或前端显示时加8小时

### 2. 历史记录名称不对 ❌
**问题**：显示名称与保存的文件名不一致  
**原因**：需要进一步检查  
**修复**：确保使用完整文件名

### 3. 简化版PDF不居中 ❌
**问题**：简化版PDF预览不居中，完整版居中正常  
**原因**：简化版和完整版的居中逻辑可能冲突  
**修复**：分别处理简化版和完整版的居中逻辑

### 4. 完整版PDF表头少内容 ❌
**问题**：完整版PDF表头缺少部分内容  
**需要**：用户提供截图说明缺少哪些内容

### 5. 简化版缺少L列表头（编制/校核/审核） ❌
**问题**：L列第1-3行应该显示"编制"、"校核"、"审核"  
**原因**：可能被第4-5行的"价格（万元）"覆盖  
**修复**：检查Excel导出时L列的处理逻辑

### 6. IJK列为什么有"/" ❌
**问题**：从截图看，IJK列（第1-3行）显示"/"  
**分析**：
- I列：空白区域
- J列：空白区域  
- K列：空白区域
**原因**：表头数据初始化时IJK列设置为"/"或空白

### 7. Excel公式错误 ❌
**简化版应该的公式**：
- **H列 = G × F** （电机总数量 = 单台电机数量 × 设备数量）
- **K列 = J × F** （总设备功率 = 单台设备功率 × 设备数量）
- **L列**：无公式（设备单价，手动输入）
- **M列 = L × F** （总价 = 单价 × 设备数量）

**当前问题**：Excel保存时公式不正确

---

## 🎯 修复优先级

### 高优先级（立即修复）
1. **Excel公式修复** - 影响数据计算
2. **简化版L列表头** - 影响导出完整性
3. **时间差8小时** - 影响用户体验

### 中优先级
4. **简化版PDF不居中** - 视觉问题
5. **历史记录名称** - 显示问题

### 低优先级
6. **IJK列的"/"** - 可能是设计如此
7. **favicon.ico 404** - 不影响功能

---

## 🔧 修复步骤

### 步骤1：修复Excel公式（简化版）

需要找到并修改`setStyleAndValue`函数中：
- H列（索引7）的公式设置
- K列（索引10）的公式设置
- M列（索引12）的公式设置

**目标代码位置**：`dist-refactored/js/modules/legacy.js` 的`setStyleAndValue`函数

### 步骤2：修复L列表头

简化版L列结构：
```
L1: 编制
L2: 校核
L3: 审核
L4-L5合并: 价格（万元）
```

**需要检查**：
1. `createSimplifiedTableHeader`函数中L列的初始化
2. Excel导出时L列的处理

### 步骤3：修复时间显示

**方案A**：后端保存时使用Asia/Shanghai时区  
**方案B**：前端显示时调整时区偏移

### 步骤4：修复简化版PDF居中

检查PDF生成时的居中计算，确保简化版和完整版都正确居中。

---

## 📝 需要用户确认的信息

1. **完整版PDF表头缺少什么内容**？
   - 缺少哪些列？
   - 缺少哪些文字？

2. **IJK列的"/"是否是预期的**？
   - 这些列在表头第1-3行应该显示什么？

3. **历史记录名称应该显示什么**？
   - 当前显示：？
   - 期望显示：？

---

## ⏰ 预计修复时间

- Excel公式修复：10分钟
- L列表头修复：5分钟
- 时间显示修复：5分钟
- PDF居中修复：10分钟

**总计：约30分钟**

---

**立即开始修复！**

