<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ç”¨æˆ·ç®¡ç† - è®¾å¤‡å‚æ•°é€‰å‹ç³»ç»Ÿ</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: 'Microsoft YaHei', 'SimSun', sans-serif;
			background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf3 100%);
			min-height: 100vh;
			padding: 20px;
		}

		.container {
			max-width: 800px;
			margin: 0 auto;
			background: white;
			border-radius: 16px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
			padding: 40px;
		}

		.header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 30px;
			padding-bottom: 20px;
			border-bottom: 2px solid #f0f0f0;
		}

		.header h1 {
			font-size: 28px;
			color: #1a1f36;
		}

		.back-btn {
			padding: 10px 20px;
			background: white;
			color: #00d4ff;
			border: 1px solid #e5e7eb;
			border-radius: 10px;
			cursor: pointer;
			font-size: 14px;
			font-weight: 600;
			transition: all 0.3s ease;
		}

		.back-btn:hover {
			background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
			color: white;
			border-color: transparent;
			transform: translateY(-2px);
			box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
		}

		.add-section {
			margin-bottom: 30px;
			padding: 25px;
			background: #f9fafb;
			border-radius: 12px;
			border: 1px solid #e5e7eb;
		}

		.add-section h2 {
			font-size: 18px;
			color: #1a1f36;
			margin-bottom: 15px;
			font-weight: 600;
		}

		.input-group {
			display: flex;
			gap: 10px;
		}

		.phone-input {
			flex: 1;
			padding: 12px 15px;
			border: 2px solid #e5e7eb;
			border-radius: 10px;
			font-size: 15px;
			background: white;
			color: #1a1f36;
			font-weight: 500;
			transition: all 0.3s ease;
		}

		.phone-input:focus {
			outline: none;
			border-color: #00d4ff;
			box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.1);
		}

		.phone-input::placeholder {
			color: #9ca3af;
		}

		.add-btn {
			padding: 12px 30px;
			background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
			color: white;
			border: none;
			border-radius: 10px;
			cursor: pointer;
			font-size: 15px;
			font-weight: 700;
			transition: all 0.3s ease;
			white-space: nowrap;
			box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
		}

		.add-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
		}

		.user-list {
			margin-top: 20px;
		}

		.user-list h2 {
			font-size: 18px;
			color: #1a1f36;
			margin-bottom: 15px;
			font-weight: 600;
		}

		.user-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 15px 20px;
			background: #f9fafb;
			border: 2px solid #e5e7eb;
			border-radius: 10px;
			margin-bottom: 10px;
			transition: all 0.3s ease;
		}

		.user-item:hover {
			border-color: #00d4ff;
			background: white;
			transform: translateX(5px);
			box-shadow: 0 2px 8px rgba(0, 212, 255, 0.15);
		}

		.user-phone {
			font-size: 16px;
			color: #1a1f36;
			font-weight: 500;
		}

		.user-badge {
			display: inline-block;
			padding: 4px 12px;
			background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
			color: white;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
			margin-left: 10px;
			box-shadow: 0 2px 8px rgba(0, 212, 255, 0.3);
		}

		.delete-btn {
			padding: 8px 16px;
			background: #ff4d4f;
			color: white;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			font-size: 13px;
			font-weight: 600;
			transition: all 0.3s ease;
		}

		.delete-btn:hover {
			background: #d32f2f;
			transform: scale(1.05);
			box-shadow: 0 2px 8px rgba(255, 77, 79, 0.3);
		}

		.delete-btn:disabled {
			background: #e5e7eb;
			color: #9ca3af;
			cursor: not-allowed;
			transform: none;
			box-shadow: none;
		}

		.empty-state {
			text-align: center;
			padding: 40px;
			color: #9ca3af;
		}

		.message {
			padding: 12px 20px;
			border-radius: 10px;
			margin-bottom: 15px;
			font-size: 14px;
			font-weight: 500;
			display: none;
		}

		.message.show {
			display: block;
			animation: slideDown 0.3s ease;
		}

		.message.success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}

		.message.error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}

		@keyframes slideDown {
			from {
				opacity: 0;
				transform: translateY(-10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.stats {
			display: flex;
			gap: 20px;
			margin-bottom: 20px;
		}

		.stat-card {
			flex: 1;
			padding: 25px;
			background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
			color: white;
			border-radius: 12px;
			text-align: center;
			box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
		}

		.stat-number {
			font-size: 36px;
			font-weight: 700;
			margin-bottom: 5px;
		}

		.stat-label {
			font-size: 14px;
			opacity: 0.95;
			font-weight: 500;
		}

		/* å“åº”å¼è®¾è®¡ */
		@media (max-width: 600px) {
			.container {
				padding: 30px 20px;
			}

			.header h1 {
				font-size: 24px;
			}

			.input-group {
				flex-direction: column;
			}

			.add-btn {
				width: 100%;
			}
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<h1>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h1>
			<div style="display: flex; align-items: center; gap: 15px;">
				<span id="adminInfo" style="color: #1a1f36; font-size: 14px; font-weight: 500;">
					<span style="color: #00d4ff;">ğŸ‘¤</span> å½“å‰ç®¡ç†å‘˜ï¼š<span id="adminPhone">-</span>
				</span>
				<button class="back-btn" onclick="window.location.href='index.html'">
					â† è¿”å›ä¸»é¡µ
				</button>
			</div>
		</div>

		<div id="message" class="message"></div>

		<div class="stats">
			<div class="stat-card">
				<div class="stat-number" id="totalUsers">0</div>
				<div class="stat-label">æˆæƒç”¨æˆ·</div>
			</div>
		</div>

		<div class="add-section">
			<h2>â• æ·»åŠ æ–°ç”¨æˆ·</h2>
			<div class="input-group">
				<input 
					type="tel" 
					id="newPhoneInput" 
					class="phone-input" 
					placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·ç "
					maxlength="11"
				>
				<button class="add-btn" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
			</div>
		</div>

		<div class="user-list">
			<h2>ğŸ“‹ æˆæƒç”¨æˆ·åˆ—è¡¨</h2>
			<div id="userListContainer"></div>
		</div>

		<!-- ç®¡ç†å‘˜ä¿®æ”¹å¯†ç åŒºåŸŸ -->
		<div class="add-section" style="margin-top: 30px;">
			<h2>ğŸ” ä¿®æ”¹æˆ‘çš„å¯†ç </h2>
			<form id="changePasswordForm" style="display: flex; flex-direction: column; gap: 15px;">
				<input 
					type="password" 
					id="currentPassword" 
					class="phone-input" 
					placeholder="è¯·è¾“å…¥å½“å‰å¯†ç "
					required
				>
				<input 
					type="password" 
					id="newPassword" 
					class="phone-input" 
					placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
					minlength="6"
					required
				>
				<input 
					type="password" 
					id="confirmNewPassword" 
					class="phone-input" 
					placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
					required
				>
				<button type="submit" class="add-btn">ğŸ’¾ ä¿å­˜æ–°å¯†ç </button>
			</form>
		</div>
	</div>

	<!-- ç™½åå•åŒæ­¥æ¨¡å— -->
	<script src="js/modules/whitelistSync.js"></script>

	<script>
		// æ˜¾ç¤ºæ¶ˆæ¯
		function showMessage(text, type = 'success') {
			const messageEl = document.getElementById('message');
			messageEl.textContent = text;
			messageEl.className = `message ${type} show`;
			setTimeout(() => {
				messageEl.classList.remove('show');
			}, 3000);
		}

		// éªŒè¯æ‰‹æœºå·
		function validatePhone(phone) {
			const phoneRegex = /^1[3-9]\d{9}$/;
			return phoneRegex.test(phone);
		}

		// è·å–ç™½åå•
		function getWhitelist() {
			const whitelist = localStorage.getItem('phoneWhitelist');
			if (!whitelist) {
				const defaultWhitelist = ['18968563368'];
				localStorage.setItem('phoneWhitelist', JSON.stringify(defaultWhitelist));
				return defaultWhitelist;
			}
			return JSON.parse(whitelist);
		}

		// ä¿å­˜ç™½åå•
		function saveWhitelist(whitelist) {
			localStorage.setItem('phoneWhitelist', JSON.stringify(whitelist));
		}

		// æ·»åŠ ç”¨æˆ·ï¼ˆä½¿ç”¨äº‘ç«¯åŒæ­¥ï¼‰
		async function addUser() {
			const phoneInput = document.getElementById('newPhoneInput');
			const phone = phoneInput.value.trim();

			if (!phone) {
				showMessage('è¯·è¾“å…¥æ‰‹æœºå·ç ', 'error');
				return;
			}

			if (!validatePhone(phone)) {
				showMessage('è¯·è¾“å…¥æ­£ç¡®çš„11ä½æ‰‹æœºå·ç ', 'error');
				return;
			}

			// ä½¿ç”¨äº‘ç«¯åŒæ­¥æ¨¡å—
			const result = await WhitelistSync.addUser(phone);
			
			if (result.success) {
				phoneInput.value = '';
				showMessage(`âœ“ æˆåŠŸæ·»åŠ ç”¨æˆ·: ${phone}ï¼ˆå·²åŒæ­¥åˆ°äº‘ç«¯ï¼‰`, 'success');
				renderUserList();
			} else {
				showMessage(result.message, 'error');
			}
		}

		// åˆ é™¤ç”¨æˆ·ï¼ˆä½¿ç”¨äº‘ç«¯åŒæ­¥ï¼‰
		async function deleteUser(phone) {
			if (phone === '18968563368') {
				showMessage('é»˜è®¤ç®¡ç†å‘˜è´¦å·ä¸èƒ½åˆ é™¤', 'error');
				return;
			}

			if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${phone} å—ï¼Ÿ\næ­¤æ“ä½œå°†åŒæ­¥åˆ°æ‰€æœ‰è®¾å¤‡`)) {
				return;
			}

			// ä½¿ç”¨äº‘ç«¯åŒæ­¥æ¨¡å—
			const result = await WhitelistSync.removeUser(phone);
			
			if (result.success) {
				showMessage(`âœ“ å·²åˆ é™¤ç”¨æˆ·: ${phone}ï¼ˆå·²åŒæ­¥åˆ°äº‘ç«¯ï¼‰`, 'success');
				renderUserList();
			} else {
				showMessage(result.message, 'error');
			}
		}

		// æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
		function renderUserList() {
			const whitelist = getWhitelist();
			const container = document.getElementById('userListContainer');
			const totalUsersEl = document.getElementById('totalUsers');

			totalUsersEl.textContent = whitelist.length;

			if (whitelist.length === 0) {
				container.innerHTML = '<div class="empty-state">æš‚æ— æˆæƒç”¨æˆ·</div>';
				return;
			}

			container.innerHTML = whitelist.map(phone => `
				<div class="user-item">
					<div>
						<span class="user-phone">ğŸ“± ${phone}</span>
						${phone === '18968563368' ? '<span class="user-badge">ç®¡ç†å‘˜</span>' : ''}
					</div>
					<button 
						class="delete-btn" 
						onclick="deleteUser('${phone}')"
						${phone === '18968563368' ? 'disabled title="é»˜è®¤ç®¡ç†å‘˜ä¸èƒ½åˆ é™¤"' : ''}
					>
						${phone === '18968563368' ? 'ğŸ”’ é”å®š' : 'ğŸ—‘ï¸ åˆ é™¤'}
					</button>
				</div>
			`).join('');
		}

		// å›è½¦é”®æ·»åŠ ç”¨æˆ·
		document.getElementById('newPhoneInput').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				addUser();
			}
		});

		// åªå…è®¸è¾“å…¥æ•°å­—
		document.getElementById('newPhoneInput').addEventListener('input', function(e) {
			this.value = this.value.replace(/\D/g, '');
		});

		// é¡µé¢åŠ è½½æ—¶ä»äº‘ç«¯åŒæ­¥å¹¶æ¸²æŸ“åˆ—è¡¨
		window.addEventListener('load', async function() {
			// æ˜¾ç¤ºå½“å‰ç®¡ç†å‘˜ä¿¡æ¯
			try {
				const sessionInfo = sessionStorage.getItem('currentSession');
				if (sessionInfo) {
					const userInfo = JSON.parse(sessionInfo);
					document.getElementById('adminPhone').textContent = userInfo.phone || 'æœªçŸ¥';
				} else {
					document.getElementById('adminPhone').textContent = 'æœªç™»å½•';
				}
			} catch (e) {
				console.error('è·å–ç®¡ç†å‘˜ä¿¡æ¯å¤±è´¥:', e);
				document.getElementById('adminPhone').textContent = 'è¯»å–å¤±è´¥';
			}
			
			// å…ˆä»äº‘ç«¯åŒæ­¥æœ€æ–°ç™½åå•
			await WhitelistSync.init();
			// å†æ¸²æŸ“åˆ—è¡¨
			renderUserList();
			
			// è°ƒè¯•ä¿¡æ¯
			console.log('ğŸ“Š å½“å‰ç™½åå• (localStorage):', localStorage.getItem('phoneWhitelist'));
			
			showMessage('âœ… ç™½åå•å·²åŠ è½½', 'success');
		});

		// ä¿®æ”¹å¯†ç è¡¨å•æäº¤
		document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
			e.preventDefault();

			const currentPassword = document.getElementById('currentPassword').value;
			const newPassword = document.getElementById('newPassword').value;
			const confirmNewPassword = document.getElementById('confirmNewPassword').value;

			// éªŒè¯æ–°å¯†ç 
			if (newPassword.length < 6) {
				showMessage('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä½', 'error');
				return;
			}

			if (newPassword !== confirmNewPassword) {
				showMessage('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
				return;
			}

			// è·å–ç®¡ç†å‘˜æ‰‹æœºå·ï¼ˆä»sessionStorageï¼‰
			const sessionInfo = sessionStorage.getItem('currentSession');
			if (!sessionInfo) {
				showMessage('ç™»å½•ä¿¡æ¯å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
				return;
			}

			const userInfo = JSON.parse(sessionInfo);
			const adminPhone = userInfo.phone;

			// è·å–ç”¨æˆ·å¯†ç å­˜å‚¨
			let userPasswords = localStorage.getItem('userPasswords');
			if (!userPasswords) {
				showMessage('å¯†ç æ•°æ®å¼‚å¸¸ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
				return;
			}

			const passwords = JSON.parse(userPasswords);

			// éªŒè¯å½“å‰å¯†ç 
			if (passwords[adminPhone] !== currentPassword) {
				showMessage('å½“å‰å¯†ç é”™è¯¯', 'error');
				return;
			}

			// æ›´æ–°å¯†ç 
			passwords[adminPhone] = newPassword;
			localStorage.setItem('userPasswords', JSON.stringify(passwords));

			// æ¸…ç©ºè¡¨å•
			document.getElementById('changePasswordForm').reset();

			showMessage('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼ä¸‹æ¬¡ç™»å½•è¯·ä½¿ç”¨æ–°å¯†ç ', 'success');
		});

	// æ£€æŸ¥ç™»å½•çŠ¶æ€ï¼ˆæ¯æ¬¡éƒ½éœ€è¦é‡æ–°ç™»å½•ï¼‰
	const sessionInfo = sessionStorage.getItem('currentSession');
	if (!sessionInfo) {
		alert('è¯·å…ˆç™»å½•');
		window.location.href = 'login.html';
	} else {
		try {
			const userInfo = JSON.parse(sessionInfo);
			// åªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®ç”¨æˆ·ç®¡ç†é¡µé¢
			if (userInfo.phone !== '18968563368') {
				alert('ä»…ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ­¤é¡µé¢');
				window.location.href = 'index.html';
			}
		} catch (e) {
			window.location.href = 'login.html';
		}
	}
	</script>
</body>
</html>
