# 🎯 智能叶轮直径推荐功能说明

## ✅ 功能概述

系统现在可以**自动推荐最佳叶轮直径D**，解决了之前"功率过大"的问题。

## 🔧 工作原理

### 1. 粗算公式（Excel C10）

```javascript
D = 27 / n × √(P / (2 × ρ × ψ))
```

**参数说明**：
- `n`：风机转速 (r/min)
- `P`：目标全压 (Pa)
- `ρ`：工况密度 (kg/m³)
- `ψ`：全压系数（从数据库预选）

### 2. 智能选择逻辑

```
IF (|用户输入D - 粗算D| / 粗算D > 30%) THEN
    使用粗算D（智能推荐）
    显示：🎯 已自动优化
ELSE
    使用用户输入D
    显示：✓ 使用用户输入值
END IF
```

### 3. 两阶段推荐策略

**阶段1：预选系数**
- 快速遍历所有风机型号的系数
- 找到最合适的 φ（流量系数）和 ψ（压力系数）
- 用于粗算D值

**阶段2：精确匹配**
- 使用智能D值重新遍历所有型号
- 计算每个点的Q_pred和P_pred
- 选择误差最小的型号和工况点

## 📊 实际效果对比

### 之前（固定D=2.2m）

```
用户输入：Q=16000 m³/h, P=4500 Pa
固定D=2.2m → 计算Q=226998 m³/h, P=5811 Pa
结果：选型功率 458 kW ⚠️ 太大！
```

### 现在（智能D≈1.0m）

```
用户输入：Q=16000 m³/h, P=4500 Pa
智能D≈1.0m → 计算Q≈18000 m³/h, P≈4700 Pa
结果：选型功率 27 kW ✅ 合理！
```

## 🎯 界面显示

### 推荐结果卡片

```
✅ 推荐风机型号
5-48 №10D

💡 推荐原因：第3工况点最接近（Q误差+12.5%，P误差+4.4%）

🎯 智能叶轮直径：1.02 m （粗算值，用户输入2.2m偏差116%，已自动优化）
```

### 功率对比

| 项目 | 需求功率 | 选型功率 | 差异 |
|------|---------|---------|------|
| 轴功率 | 25.0 kW | 27.3 kW | ✅ 接近 |
| 电机功率 | 29.3 kW | 32.0 kW | ✅ 合理 |

**说明**：
- ✅ 两者接近 = D值选择合理
- ⚠️ 差异过大 = D值可能需要调整

## 🔍 技术细节

### 系数预选算法

```javascript
// 遍历所有型号，找到"中等偏好"的系数
let bestPreselect = { error: Infinity };
for (const [model, data] of Object.entries(FAN_COEFFICIENTS_DATABASE)) {
    for (let i = 0; i < 7; i++) {
        const phi = data.flow_coefficients[i];
        const psi = data.pressure_coefficients[i];
        
        // 偏好中等系数（φ≈0.2, ψ≈0.5）
        const score = Math.abs(phi - 0.2) + Math.abs(psi - 0.5);
        
        if (score < bestPreselect.error) {
            bestPreselect = { phi, psi, eta };
        }
    }
}
```

### D值自动优化阈值

- **30%偏差**：触发自动优化
- **<30%偏差**：使用用户输入值

```javascript
const deviationPct = Math.abs(userInputD - roughD) / roughD * 100;

if (deviationPct > 30) {
    smartD = roughD;  // 自动优化
} else {
    smartD = userInputD;  // 保留用户输入
}
```

## 📋 使用建议

### 场景1：首次选型（不确定D值）

1. 输入流量、压力、转速等参数
2. 叶轮直径随便输入一个值（如2.0m）
3. 点击"开始选型计算"
4. 系统自动计算并应用最优D值
5. 查看推荐结果和功率对比

### 场景2：已知D值（验证选型）

1. 输入已知的D值
2. 如果D值合理（偏差<30%），系统使用您的输入
3. 如果D值偏离太大，系统自动优化并提示

### 场景3：微调D值

1. 查看智能推荐的D值
2. 在输入框手动调整±10%
3. 重新计算，观察功率变化
4. 找到最佳平衡点

## ⚙️ 配置参数

### 可调整参数

```javascript
// 在代码中可以修改这些阈值
const DEVIATION_THRESHOLD = 30;  // D值偏差阈值（%）
const DEFAULT_PHI = 0.2;          // 默认流量系数
const DEFAULT_PSI = 0.5;          // 默认压力系数
const DEFAULT_ETA = 0.82;         // 默认效率
```

### 系数偏好调整

```javascript
// 修改系数偏好（当前偏好中等值）
const score = Math.abs(phi - 0.2) + Math.abs(psi - 0.5);

// 可改为偏好高流量系数
const score = Math.abs(phi - 0.3) + Math.abs(psi - 0.4);
```

## 🎓 理论依据

### 粗算公式推导

从风机相似定律和无量纲系数：

```
P = ψ × ρ × u²
u = π × D × n / 60

代入得：
P = ψ × ρ × (π × D × n / 60)²

解出D：
D = (60 / (π × n)) × √(P / (ρ × ψ))
≈ 27 / n × √(P / (2 × ρ × ψ))
```

### 为什么是27？

```
60 / π ≈ 19.1
考虑经验修正系数 √2 ≈ 1.414
19.1 × 1.414 ≈ 27
```

## 📈 后续优化方向

1. **迭代优化**：多轮迭代逼近最优D值
2. **范围限制**：根据型号设置D的合理范围
3. **历史学习**：记录用户调整偏好
4. **多目标优化**：同时优化D和型号选择

---

**更新时间**：2025-10-14  
**功能版本**：v2.0 - 智能叶轮直径推荐


