# 🚀 Luckysheet 选型系统 - 免费部署指南

本指南将帮助您将系统部署到免费的云服务器上。

## 📋 部署方案

- **前端（静态文件）**: Vercel（免费，全球CDN加速）
- **后端（Django API）**: Render（免费tier，PostgreSQL数据库）

---

## 🎯 第一部分：部署后端（Django）到 Render

### 1. 准备工作

1. 访问 [Render.com](https://render.com) 并注册账号（免费）
2. 确保您的代码已推送到 GitHub/GitLab（Render支持自动部署）

### 2. 创建 PostgreSQL 数据库

1. 登录 Render 控制台
2. 点击 **"New +"** → 选择 **"PostgreSQL"**
3. 配置数据库：
   - **Name**: `cable-selector-db`
   - **Database**: `cable_selector`
   - **User**: `cable_selector_user`
   - **Region**: 选择离你最近的区域（如 Oregon）
   - **Plan**: 选择 **"Free"**（免费tier，90天后删除，但可以重新创建）
4. 点击 **"Create Database"**
5. 等待创建完成后，复制 **Internal Database URL**（类似 `postgresql://...`）

### 3. 部署 Django 应用

#### 方式A：使用 render.yaml（推荐）

1. 在 Render 控制台点击 **"New +"** → **"Blueprint"**
2. 连接你的 GitHub 仓库
3. 选择包含 `xuanxing/backend/render.yaml` 的仓库
4. Render 会自动识别配置并创建服务

#### 方式B：手动创建服务

1. 点击 **"New +"** → **"Web Service"**
2. 连接你的 GitHub 仓库
3. 配置服务：
   - **Name**: `cable-selector-backend`
   - **Region**: Oregon（或其他区域）
   - **Branch**: main（或你的主分支）
   - **Root Directory**: `xuanxing/backend`
   - **Runtime**: Python 3
   - **Build Command**: 
     ```bash
     pip install -r requirements.txt && python manage.py collectstatic --no-input && python manage.py migrate && python manage.py load_initial_data
     ```
   - **Start Command**: 
     ```bash
     gunicorn cable_selector.wsgi:application
     ```
   - **Plan**: Free（免费）

4. 配置环境变量（Environment Variables）：
   - `SECRET_KEY`: 点击 "Generate" 自动生成（或手动设置一个长随机字符串）
   - `DEBUG`: `False`
   - `ALLOWED_HOSTS`: `你的render域名.onrender.com`（部署后会显示）
   - `DATABASE_URL`: 从第2步复制的数据库URL
   - `CORS_ALLOWED_ORIGINS`: `https://你的vercel域名.vercel.app`（稍后从Vercel获取）

5. 点击 **"Create Web Service"**

6. 等待部署完成（约3-5分钟）

7. 部署完成后，记录你的后端URL：`https://你的服务名.onrender.com`

### 4. 测试后端API

访问以下URL测试：
```
https://你的服务名.onrender.com/api/cables/
```

如果返回JSON数据，说明后端部署成功！✅

---

## 🎨 第二部分：部署前端到 Vercel

### 1. 准备工作

1. 访问 [Vercel.com](https://vercel.com) 并注册账号（推荐使用GitHub登录）
2. 安装 Vercel CLI（可选）：
   ```bash
   npm install -g vercel
   ```

### 2. 部署前端

#### 方式A：通过 Vercel 网站（推荐，最简单）

1. 登录 Vercel 控制台
2. 点击 **"Add New Project"**
3. 选择 **"Import Git Repository"** 并授权 GitHub
4. 选择你的项目仓库
5. 配置项目：
   - **Project Name**: `luckysheet-selection-system`
   - **Framework Preset**: Other（其他）
   - **Root Directory**: 留空（使用根目录）
   - **Build Command**: 留空（静态文件，无需构建）
   - **Output Directory**: `dist-refactored`
   - **Install Command**: 留空
6. 点击 **"Deploy"**
7. 等待部署完成（约1-2分钟）
8. 记录你的前端URL：`https://你的项目名.vercel.app`

#### 方式B：通过 Vercel CLI

```bash
# 在项目根目录执行
cd C:\Users\Administrator\Desktop\Luckysheet-master-2.0.2
vercel --prod
```

按提示操作即可。

### 3. 配置前端连接后端

前端需要连接到 Render 上的后端API。找到以下文件并修改API地址：

**修改文件**: `dist-refactored/cable-selector/assets/*.js`

查找并替换所有API调用地址：
```javascript
// 原来的本地地址
const API_URL = 'http://localhost:8000/api';

// 改为 Render 的后端地址
const API_URL = 'https://你的服务名.onrender.com/api';
```

修改后重新部署（Vercel会自动检测到更改并重新部署）。

### 4. 更新后端CORS配置

回到 Render 后端服务，更新环境变量：

- `CORS_ALLOWED_ORIGINS`: 添加你的 Vercel 前端地址
  ```
  https://你的项目名.vercel.app,http://localhost:3000
  ```

- `ALLOWED_HOSTS`: 添加 Render 域名
  ```
  你的服务名.onrender.com,.vercel.app
  ```

保存后，Render 会自动重新部署。

---

## ✅ 第三部分：测试完整部署

1. 访问前端地址：`https://你的项目名.vercel.app`
2. 测试以下功能：
   - 主页加载正常
   - 离心风机选型功能（纯前端，应该能用）
   - 电缆选型功能（需要后端API）
   - 打开Excel文件并编辑

如果电缆选型功能正常工作，说明前后端连接成功！🎉

---

## 📊 免费服务限制

### Vercel（前端）
- ✅ 无限带宽
- ✅ 全球CDN
- ✅ 自动HTTPS
- ⚠️ 每月构建时间有限（对静态文件无影响）

### Render（后端）
- ✅ 512MB RAM
- ✅ 免费PostgreSQL（100MB存储，90天后删除，可重新创建）
- ⚠️ 15分钟无活动会休眠（首次访问会慢3-5秒）
- ⚠️ 每月750小时运行时间（够用）

---

## 🔧 常见问题

### Q: Render服务启动很慢？
**A**: 免费tier会在15分钟无活动后休眠，首次访问需要3-5秒唤醒。可以使用 [UptimeRobot](https://uptimerobot.com) 每5分钟ping一次保持活跃。

### Q: 数据库90天后会删除？
**A**: 是的，但你可以提前导出数据，然后创建新数据库并导入。或者升级到付费plan（$7/月）。

### Q: 如何更新代码？
**A**: 
- **Vercel**: 推送到GitHub，自动部署
- **Render**: 推送到GitHub，自动部署

### Q: 如何查看后端日志？
**A**: 登录 Render 控制台 → 选择你的服务 → 点击 "Logs" 标签

### Q: 前端访问后端API报错 CORS?
**A**: 检查 Render 后端的 `CORS_ALLOWED_ORIGINS` 环境变量是否包含 Vercel 前端域名。

---

## 🎯 下一步优化

1. **自定义域名**:
   - Vercel: 免费支持自定义域名
   - Render: 免费支持自定义域名

2. **性能优化**:
   - 使用 Vercel 的 Edge Functions
   - 启用前端缓存

3. **监控和告警**:
   - 使用 Vercel Analytics（免费）
   - 使用 Sentry 错误追踪（免费tier）

---

## 📞 需要帮助？

如果遇到问题，请检查：
1. Render 服务的 Logs（日志）
2. Vercel 部署的 Deployment Logs
3. 浏览器开发者工具的 Console 和 Network 标签

---

**祝部署顺利！🚀**

