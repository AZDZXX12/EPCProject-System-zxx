# ✅ 简化版I/J/K列逻辑修复说明

## 📝 用户需求

### 简化版I列和J列的逻辑
1. **I列（电机功率KW）**：保存用户输入的原始数据
   - 可以是表达式：如 `11+22`
   - 可以是数值：如 `11`

2. **J列（单台设备功率）**：根据I列内容自动计算
   - 如果I列是**表达式**（如`11+22`）→ J列显示**计算结果**（33）
   - 如果I列是**数值**（如`11`）→ J列显示 **I × G**（电机功率 × 电机总数量）

3. **K列（总设备功率）**：显示 **J × F**（单台设备功率 × 设备数量）

### 历史记录保存提示
- 保存成功后显示完整文件名
- 让用户知道保存了什么文件

---

## 🔧 修复方案

### 修复1：I/J/K列逻辑（简化版）

**文件**：`dist-refactored/js/modules/legacy.js`

**修复位置**：第9282-9323行

**修复前的问题**：
- J列使用公式 `=I*G`，导致I列是表达式时计算错误
- K列使用公式 `=J*F`，没有直接计算值

**修复后的逻辑**：
```javascript
// 🔥 J列：单台设备功率（I列是表达式→直接显示结果，I列是数字→I×G）
const iVal = String(motorPowerRaw || '').trim();
const gQty = parseFloat(motorQuantityTotal) || 0; // G列：电机总数量
let jValue = '';

if (iVal && /[\+\-\*\/]/.test(iVal) && !/^[\-]?\d+(\.\d+)?$/.test(iVal)) {
    // 情况1：I是表达式（如"11+22"），J直接显示计算结果
    try {
        jValue = eval(iVal);
    } catch (e) {
        jValue = '';
    }
    console.log(`✅ 简化版J列：I列是表达式"${iVal}"，J列显示计算结果 ${jValue}`);
} else if (iVal && iVal !== '/') {
    // 情况2：I是数字（如"11"），J = I × G
    const iNum = parseFloat(iVal) || 0;
    jValue = iNum * gQty;
    console.log(`✅ 简化版J列：I列是数字"${iVal}"，J = I × G = ${iNum} × ${gQty} = ${jValue}`);
}

// 保存J列的值（不是公式）
luckysheet.setCellValue(insertRow, 9, {
    v: jValue || '',
    m: jValue ? String(jValue) : '',
    ct: { fa: "General", t: "n" },
    ff: "SimSun",
    fs: 10,
    ht: 0,
    vt: 0
});

// 🔥 K列：总设备功率 = J × F（直接计算值）
const kValue = jValue ? (parseFloat(jValue) * quantity) : '';
luckysheet.setCellValue(insertRow, 10, {
    v: kValue || '',
    m: kValue ? String(kValue) : '',
    ct: { fa: "General", t: "n" },
    ff: "SimSun",
    fs: 10,
    ht: 0,
    vt: 0
});
```

---

### 修复2：历史记录保存提示

**Excel保存成功提示**（第10785行）：
```javascript
SelectionHistory.showSuccess(`✅ Excel已自动保存到历史记录\n📄 文件名：${fileName}`, 3000);
```

**PDF保存成功提示**（第10837行）：
```javascript
SelectionHistory.showSuccess(`✅ PDF已自动保存到历史记录\n📄 文件名：${fileName}`, 3000);
```

**改进点**：
- ✅ 显示完整文件名
- ✅ 提示时间延长至3秒（原2秒）
- ✅ 使用多行格式，更清晰

---

## 📊 计算示例

### 示例1：I列是表达式

| 列 | 列名 | 输入值 | 计算逻辑 | 结果 |
|---|------|-------|---------|------|
| F | 数量 | 2 | - | 2 |
| G | 电机总数量 | 3 | - | 3 |
| I | 电机功率(KW) | `11+22` | - | `11+22` |
| J | 单台设备功率 | - | eval("11+22") = 33 | **33** |
| K | 总设备功率 | - | 33 × 2 = 66 | **66** |

**说明**：
- I列保存原始表达式 `11+22`
- J列计算表达式结果 = `33`
- K列 = J × F = `33 × 2 = 66`

---

### 示例2：I列是数值

| 列 | 列名 | 输入值 | 计算逻辑 | 结果 |
|---|------|-------|---------|------|
| F | 数量 | 2 | - | 2 |
| G | 电机总数量 | 3 | - | 3 |
| I | 电机功率(KW) | `11` | - | `11` |
| J | 单台设备功率 | - | 11 × 3 = 33 | **33** |
| K | 总设备功率 | - | 33 × 2 = 66 | **66** |

**说明**：
- I列保存数值 `11`
- J列 = I × G = `11 × 3 = 33`
- K列 = J × F = `33 × 2 = 66`

---

## 🔍 技术细节

### 表达式识别逻辑
```javascript
if (iVal && /[\+\-\*\/]/.test(iVal) && !/^[\-]?\d+(\.\d+)?$/.test(iVal)) {
    // 包含运算符 且 不是负数 → 是表达式
}
```

**判断条件**：
1. `iVal` 非空
2. 包含运算符：`+ - * /`
3. 不是负数（如 `-11.5` 不是表达式）

**示例**：
- ✅ `11+22` → 表达式
- ✅ `5*2` → 表达式
- ✅ `10/2` → 表达式
- ❌ `11` → 数值
- ❌ `-11.5` → 负数（数值）
- ❌ `/` → 占位符（非数值）

---

### eval()安全性说明

**使用场景**：
- 仅用于计算用户在**当前页面**输入的数学表达式
- 不涉及外部数据或网络请求
- 用户输入的表达式仅在客户端执行

**安全措施**：
```javascript
try {
    jValue = eval(iVal);
} catch (e) {
    jValue = '';
}
```
- 使用 `try-catch` 捕获错误
- 计算失败时返回空值，不影响系统运行

**替代方案**（可选优化）：
```javascript
// 使用Function构造函数（更安全）
try {
    jValue = new Function('return ' + iVal)();
} catch (e) {
    jValue = '';
}
```

---

## 🧪 测试验证

### 测试1：表达式计算
1. 新建简化版工作表
2. 添加设备，I列输入 `11+22`
3. 检查J列显示 `33`
4. 检查K列显示 `33 × F列数量`

### 测试2：数值计算
1. 新建简化版工作表
2. 添加设备，I列输入 `11`
3. 检查J列显示 `11 × G列电机总数`
4. 检查K列显示 `J列 × F列数量`

### 测试3：历史记录保存
1. 保存Excel文件
2. 查看提示是否显示文件名
3. 检查历史记录页面是否保存成功

### 测试4：导出Excel
1. 导出简化版为Excel
2. 打开Excel文件
3. 检查I/J/K列数值是否正确
4. 检查是否有公式（应该都是值）

---

## 📝 注意事项

### 1. J列和K列保存的是值，不是公式
- ✅ 优点：Excel打开后直接显示结果，不需要重新计算
- ⚠️ 缺点：如果修改I列、G列或F列，J/K列不会自动更新

### 2. 表达式仅支持简单数学运算
- 支持：`+`、`-`、`*`、`/`
- 支持：括号 `()`
- 支持：小数 `11.5+22.3`
- 不支持：函数（如 `sqrt()`、`pow()` 等）

### 3. 历史记录文件名
- 文件名包含日期和时间戳
- 保存到云端时使用完整文件名
- 历史记录列表中显示文件名

---

## ✅ 修复确认清单

- [x] I列保存原始输入（表达式或数值）
- [x] J列根据I列类型自动计算
- [x] K列显示J×F的计算结果
- [x] J/K列保存计算值（非公式）
- [x] 历史记录提示显示文件名
- [x] 提示时间延长至3秒
- [x] 代码已提交到Git
- [x] 代码已推送到GitHub
- [ ] 用户测试通过（**待验证**）

---

## 🚀 使用说明

### 对于用户

1. **刷新浏览器**
   ```
   按 Ctrl + F5 强制刷新
   ```

2. **添加设备时**
   - I列可以输入表达式（如 `11+22`）或数值（如 `11`）
   - J列会自动计算显示结果
   - K列会自动计算显示总功率

3. **保存文件后**
   - 会弹出提示框，显示保存的文件名
   - 可以在"历史记录"中查看保存的文件

4. **查看历史记录**
   - 点击左上角"历史记录"按钮
   - 查看之前保存的所有文件
   - 可以下载或查看文件详情

---

**🎉 修复完成！请刷新浏览器测试！**

**📝 测试重点**：
1. I列输入 `11+22`，J列是否显示 `33`
2. I列输入 `11`，J列是否显示 `11×G列`
3. 保存文件后是否显示文件名
4. 历史记录是否正确保存

