# Electron 内置 HTTP 服务器更新说明

## 📋 更新内容

为了解决电缆选型工具（React应用）在桌面版中无法运行的问题，我们在Electron主进程中集成了内置HTTP服务器。

## 🎯 主要改动

### 1. **main.js - 添加HTTP服务器**
- 启动时自动运行本地HTTP服务器（端口：8765）
- 使用 `http://localhost:8765/index.html` 加载应用，而不是 `file://` 协议
- 应用退出时自动关闭HTTP服务器
- 支持所有静态资源（HTML、JS、CSS、图片、字体等）

### 2. **wordEditor.js - 优化工具打开逻辑**
- **电缆选型工具**：在Electron环境中直接打开（无需HTTP协议检查）
- **YJV数据表**：在Electron环境中直接打开
- **离心风机选型**：保持原有逻辑
- **Word编辑器**：保持原有逻辑

### 3. **index.html - 更新协议检测**
- Electron环境中不显示 `file://` 协议警告
- 区分Electron和浏览器环境的提示信息

## ✅ 解决的问题

1. ❌ **之前**：电缆选型工具在Electron中点击后提示需要HTTP服务器
2. ✅ **现在**：所有工具（包括React应用）都能在Electron中正常打开

## 🚀 使用方式

### 开发模式
```bash
npm run electron-dev
```

### 生产模式
```bash
npm start
# 或
npm run electron
```

### 打包
```bash
# Windows 安装包
npm run dist:win

# 所有平台
npm run dist
```

## 🔧 技术细节

### HTTP服务器配置
- **端口**：8765（硬编码，避免冲突）
- **根目录**：`dist-refactored/`
- **MIME类型**：支持所有常见文件类型
- **安全性**：路径检查，防止目录遍历攻击
- **CORS**：允许跨域请求（`Access-Control-Allow-Origin: *`）

### 打开新窗口的行为
所有工具（Word编辑器、风机选型、电缆选型、YJV数据表）都通过 `window.open()` 在新窗口中打开：
- Electron环境：使用窗口配置参数（隐藏菜单栏等）
- 浏览器环境：在新标签页打开

## 📦 打包说明

打包后的应用会包含：
- `main.js`：主进程（包含HTTP服务器）
- `dist-refactored/`：所有静态资源
- 其他必要文件（preload.js、package.json等）

**注意**：由于使用 `http://localhost:8765` 加载应用，打包后的应用启动时会先启动HTTP服务器（约500ms），然后再显示窗口。

## ⚠️ 潜在问题

1. **端口占用**：如果8765端口被占用，应用将无法启动
   - 解决方案：可以在代码中添加端口检测和自动切换逻辑

2. **防火墙提示**：Windows可能提示允许网络访问
   - 原因：HTTP服务器需要监听本地端口
   - 安全性：只监听 `localhost`，外部网络无法访问

3. **启动延迟**：窗口显示前需要等待HTTP服务器启动
   - 当前延迟：500ms
   - 可优化：使用回调或Promise等待服务器就绪

## 🎉 优势

1. ✅ **统一体验**：所有页面都通过HTTP协议访问，行为一致
2. ✅ **支持React应用**：完美支持Vite构建的React应用
3. ✅ **无需外部依赖**：使用Node.js内置 `http` 模块，无需额外安装
4. ✅ **兼容性好**：浏览器环境仍可正常使用（通过外部HTTP服务器）
5. ✅ **开发友好**：开发和生产环境行为一致

## 📝 后续优化建议

1. **动态端口分配**：检测端口占用，自动选择可用端口
2. **加载优化**：使用Promise等待服务器启动，移除硬编码延迟
3. **错误处理**：添加服务器启动失败的提示和降级方案
4. **性能监控**：记录HTTP服务器性能指标
5. **安全增强**：添加请求日志和访问控制

---

**更新日期**：2025-10-15  
**版本**：v1.0.2

