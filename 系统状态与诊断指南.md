# EPCé¡¹ç›®ç®¡ç†ç³»ç»Ÿ - çŠ¶æ€ä¸è¯Šæ–­æŒ‡å—

> **æ›´æ–°æ—¶é—´**: 2025å¹´10æœˆ24æ—¥  
> **ç³»ç»Ÿç‰ˆæœ¬**: SQLiteæ•°æ®åº“ç‰ˆ v2.0.0

---

## ğŸ¯ å½“å‰ç³»ç»ŸçŠ¶æ€

### âœ… å·²å®Œæˆçš„å‡çº§

1. **SQLiteæ•°æ®åº“** - çœŸæ­£çš„æ•°æ®æŒä¹…åŒ–
   - æ•°æ®åº“æ–‡ä»¶: `server/data/epc_system.db`
   - è¡¨: projects, tasks, devices
   - ç´¢å¼•: project_id, statusç­‰
   - å¤§å°: ~0.04 MB

2. **åç«¯æœåŠ¡** - FastAPI + SQLite
   - åœ°å€: http://localhost:8000
   - æ–‡æ¡£: http://localhost:8000/docs
   - çŠ¶æ€: âœ… è¿è¡Œä¸­
   - ç‰ˆæœ¬: 2.0.0

3. **APIç«¯ç‚¹** - å…¨éƒ¨æ­£å¸¸å·¥ä½œ
   ```
   âœ… GET  /health                      - å¥åº·æ£€æŸ¥
   âœ… GET  /api/v1/projects/           - é¡¹ç›®åˆ—è¡¨
   âœ… POST /api/v1/projects/           - åˆ›å»ºé¡¹ç›®
   âœ… GET  /api/v1/tasks/              - ä»»åŠ¡åˆ—è¡¨
   âœ… POST /api/v1/tasks/              - åˆ›å»ºä»»åŠ¡
   âœ… GET  /api/v1/devices/            - è®¾å¤‡åˆ—è¡¨
   âœ… GET  /api/v1/auth/csrf/          - CSRF Token
   âœ… POST /api/v1/auth/login/         - ç™»å½•
   âœ… GET  /api/v1/database/info       - æ•°æ®åº“ä¿¡æ¯
   ```

---

## âš ï¸ å½“å‰é—®é¢˜è¯Šæ–­

### é—®é¢˜ï¼šç”˜ç‰¹å›¾æç¤º"åç«¯è¿æ¥è¶…æ—¶"

**ç°è±¡**:
```
DhtmlxGanttChart.tsx:478 æ— æ³•è¿æ¥åç«¯ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®: 
åç«¯è¿æ¥è¶…æ—¶ï¼ˆ5ç§’ï¼‰ï¼Œå·²è‡ªåŠ¨åˆ‡æ¢æœ¬åœ°æ¨¡å¼
```

**å¯èƒ½åŸå› **:

#### 1. æ²¡æœ‰é€‰ä¸­é¡¹ç›® âœ…ï¼ˆæœ€å¯èƒ½ï¼‰
- ç”˜ç‰¹å›¾éœ€è¦å…ˆé€‰æ‹©ä¸€ä¸ªé¡¹ç›®
- æ£€æŸ¥: é¡µé¢é¡¶éƒ¨æ˜¯å¦æœ‰é¡¹ç›®é€‰æ‹©å™¨
- è§£å†³: åˆ›å»ºé¡¹ç›®å¹¶é€‰ä¸­

#### 2. æµè§ˆå™¨Fetchè¶…æ—¶ï¼ˆæ¬¡è¦ï¼‰
- curlæµ‹è¯•æ­£å¸¸ï¼Œä½†æµè§ˆå™¨fetchè¶…æ—¶
- å¯èƒ½æ˜¯CORSã€CSPæˆ–ç½‘ç»œæ ˆé—®é¢˜
- ä½¿ç”¨æµ‹è¯•é¡µé¢è¯Šæ–­

#### 3. Electronç¯å¢ƒé™åˆ¶ï¼ˆå¦‚æœä½¿ç”¨Electronï¼‰
- Electronçš„webSecurityå¯èƒ½é˜»æ­¢localhost
- éœ€è¦åœ¨main.jsé…ç½®webPreferences

---

## ğŸ” è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1ï¼šæ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ

æ‰“å¼€å‘½ä»¤è¡Œï¼š
```bash
curl http://localhost:8000/health
```

**æœŸæœ›ç»“æœ**:
```json
{"status":"healthy","database":"sqlite","version":"2.0.0"}
```

å¦‚æœå¤±è´¥ï¼Œè¿è¡Œï¼š
```bash
cd server
python -m uvicorn sqlite-server:app --host 0.0.0.0 --port 8000 --reload
```

---

### æ­¥éª¤2ï¼šæµ‹è¯•APIè¿æ¥

#### æ–¹æ³•Aï¼šä½¿ç”¨æµ‹è¯•é¡µé¢ï¼ˆæ¨èï¼‰
1. åœ¨æµè§ˆå™¨æ‰“å¼€: http://localhost:3001/test-fetch.html
2. ç‚¹å‡»æ‰€æœ‰æµ‹è¯•æŒ‰é’®
3. æŸ¥çœ‹ç»“æœå’Œè€—æ—¶

#### æ–¹æ³•Bï¼šä½¿ç”¨curl
```bash
# æµ‹è¯•é¡¹ç›®API
curl http://localhost:8000/api/v1/projects/

# æµ‹è¯•ä»»åŠ¡API
curl "http://localhost:8000/api/v1/tasks/?project_id=TEST"

# æµ‹è¯•æ•°æ®åº“ä¿¡æ¯
curl http://localhost:8000/api/v1/database/info
```

---

### æ­¥éª¤3ï¼šæ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°

æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰ï¼ŒæŸ¥çœ‹ï¼š

1. **Consoleæ ‡ç­¾**:
   - æŸ¥æ‰¾`[Gantt] Loading tasks from:` æ—¥å¿—
   - ç¡®è®¤URLæ˜¯å¦æ­£ç¡®

2. **Networkæ ‡ç­¾**:
   - ç­›é€‰XHR/Fetchè¯·æ±‚
   - æŸ¥çœ‹`/api/v1/tasks/`è¯·æ±‚
   - æ£€æŸ¥çŠ¶æ€ç å’Œè€—æ—¶
   - æŸ¥çœ‹Headersï¼ˆCORSç›¸å…³ï¼‰

3. **Applicationæ ‡ç­¾**:
   - æ£€æŸ¥LocalStorage
   - ç¡®è®¤å½“å‰é€‰ä¸­çš„é¡¹ç›®

---

### æ­¥éª¤4ï¼šåˆ›å»ºé¡¹ç›®æµ‹è¯•

1. è¿›å…¥**å·¥ä½œå°**é¡µé¢
2. ç‚¹å‡»**æ–°å»ºé¡¹ç›®**
3. å¡«å†™é¡¹ç›®ä¿¡æ¯ï¼š
   ```
   é¡¹ç›®åç§°: æµ‹è¯•é¡¹ç›®001
   é¡¹ç›®æè¿°: SQLiteæ•°æ®åº“æµ‹è¯•
   çŠ¶æ€: planning
   é¢„ç®—: 1000000
   ```
4. ä¿å­˜åï¼Œåœ¨**é¡¶éƒ¨é¡¹ç›®é€‰æ‹©å™¨**é€‰ä¸­è¿™ä¸ªé¡¹ç›®
5. è¿›å…¥**ç”˜ç‰¹å›¾**é¡µé¢
6. åº”è¯¥å¯ä»¥æ­£å¸¸åŠ è½½ï¼ˆæˆ–æ˜¾ç¤ºç©ºä»»åŠ¡åˆ—è¡¨ï¼‰

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šåç«¯æ— æ³•å¯åŠ¨

**é”™è¯¯**: `ModuleNotFoundError: No module named 'fastapi'`

**è§£å†³**:
```bash
cd server
pip install fastapi uvicorn pydantic
```

---

### é—®é¢˜2ï¼šæ•°æ®åº“æ–‡ä»¶æƒé™é”™è¯¯

**é”™è¯¯**: `PermissionError: [Errno 13] Permission denied`

**è§£å†³**:
```bash
# Windows
attrib -r server\data\epc_system.db

# æˆ–åˆ é™¤å¹¶é‡æ–°åˆ›å»º
del server\data\epc_system.db
python server\database.py
```

---

### é—®é¢˜3ï¼šCORSé”™è¯¯

**é”™è¯¯**: `Access-Control-Allow-Origin header is missing`

**æ£€æŸ¥**: `server/sqlite-server.py`çš„CORSé…ç½®
```python
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # ç¡®ä¿æ˜¯ "*"
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

---

### é—®é¢˜4ï¼šç«¯å£è¢«å ç”¨

**é”™è¯¯**: `[Errno 10048] Only one usage of each socket address`

**è§£å†³**:
```bash
# æŸ¥æ‰¾å ç”¨8000ç«¯å£çš„è¿›ç¨‹
netstat -ano | findstr :8000

# åœæ­¢Pythonè¿›ç¨‹
taskkill /F /IM python.exe

# é‡æ–°å¯åŠ¨åç«¯
cd server
python -m uvicorn sqlite-server:app --host 0.0.0.0 --port 8000 --reload
```

---

## ğŸ“Š æ€§èƒ½åŸºå‡†

æ­£å¸¸æƒ…å†µä¸‹çš„å“åº”æ—¶é—´ï¼š

| APIç«¯ç‚¹ | æœŸæœ›è€—æ—¶ | è¯´æ˜ |
|---------|---------|------|
| /health | < 50ms | å¥åº·æ£€æŸ¥ |
| /api/v1/projects/ (ç©º) | < 100ms | è·å–é¡¹ç›®åˆ—è¡¨ |
| /api/v1/tasks/ (ç©º) | < 100ms | è·å–ä»»åŠ¡åˆ—è¡¨ |
| POST /api/v1/projects/ | < 200ms | åˆ›å»ºé¡¹ç›® |
| /api/v1/database/info | < 150ms | æ•°æ®åº“ä¿¡æ¯ |

å¦‚æœè¶…è¿‡1ç§’ï¼Œè¯´æ˜æœ‰æ€§èƒ½é—®é¢˜ã€‚

---

## ğŸš€ å¿«é€Ÿå¯åŠ¨å‘½ä»¤

### å¯åŠ¨åç«¯ï¼ˆSQLiteç‰ˆï¼‰
```bash
cd server
python -m uvicorn sqlite-server:app --host 0.0.0.0 --port 8000 --reload
```

æˆ–ä½¿ç”¨æ‰¹å¤„ç†ï¼š
```bash
.\å¯åŠ¨SQLiteåç«¯.bat
```

### å¯åŠ¨å‰ç«¯
```bash
cd client
npm start
```

### åŒæ—¶å¯åŠ¨ï¼ˆæ¨èï¼‰
```bash
# ç»ˆç«¯1ï¼šåç«¯
cd server && python -m uvicorn sqlite-server:app --host 0.0.0.0 --port 8000 --reload

# ç»ˆç«¯2ï¼šå‰ç«¯
cd client && npm start
```

---

## ğŸ“ é‡è¦æ–‡ä»¶ä½ç½®

```
xiangmu/
â”œâ”€â”€ server/
â”‚   â”œâ”€â”€ database.py          # SQLiteæ•°æ®åº“ç®¡ç†
â”‚   â”œâ”€â”€ sqlite-server.py     # FastAPIåç«¯ä¸»æ–‡ä»¶
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ epc_system.db    # SQLiteæ•°æ®åº“æ–‡ä»¶ âœ…
â”‚       â””â”€â”€ backup/          # æ•°æ®åº“å¤‡ä»½ç›®å½•
â”œâ”€â”€ client/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ config.ts        # APIé…ç½®
â”‚   â”‚   â””â”€â”€ pages/
â”‚   â”‚       â””â”€â”€ DhtmlxGanttChart.tsx  # ç”˜ç‰¹å›¾
â”‚   â””â”€â”€ public/
â”‚       â””â”€â”€ test-fetch.html  # APIæµ‹è¯•é¡µé¢ âœ…
â””â”€â”€ å¯åŠ¨SQLiteåç«¯.bat       # ä¸€é”®å¯åŠ¨è„šæœ¬
```

---

## âœ… éªŒè¯æ¸…å•

å®Œæˆä»¥ä¸‹æ£€æŸ¥ç¡®è®¤ç³»ç»Ÿæ­£å¸¸ï¼š

- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨ (http://localhost:8000)
- [ ] `/health` è¿”å› 200 OK
- [ ] `/api/v1/projects/` è¿”å› 200 OK
- [ ] `/api/v1/database/info` æ˜¾ç¤ºSQLiteæ¨¡å¼
- [ ] å‰ç«¯å¯ä»¥è®¿é—® (http://localhost:3001)
- [ ] å·¥ä½œå°å¯ä»¥åˆ›å»ºé¡¹ç›®
- [ ] é¡¹ç›®æ•°æ®åˆ·æ–°åä»ç„¶å­˜åœ¨
- [ ] ç”˜ç‰¹å›¾å¯ä»¥é€‰æ‹©é¡¹ç›®
- [ ] ç”˜ç‰¹å›¾å¯ä»¥æ·»åŠ ä»»åŠ¡
- [ ] ä»»åŠ¡æ•°æ®æŒä¹…åŒ–ä¿å­˜

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

å¦‚æœæ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **æ·»åŠ æ›´å¤šç¤ºä¾‹æ•°æ®** - åˆ›å»ºå‡ ä¸ªæµ‹è¯•é¡¹ç›®å’Œä»»åŠ¡
2. **æµ‹è¯•æ•°æ®å¤‡ä»½** - ä½¿ç”¨ `/api/v1/database/backup`
3. **æ€§èƒ½ä¼˜åŒ–** - å¤§æ•°æ®é‡æµ‹è¯•
4. **Electronæ‰“åŒ…** - åˆ¶ä½œæ¡Œé¢åº”ç”¨
5. **ç”¨æˆ·è®¤è¯** - å®ç°çœŸå®çš„ç™»å½•ç³»ç»Ÿ

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºå’ŒNetworkæ ‡ç­¾ï¼Œæä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼


