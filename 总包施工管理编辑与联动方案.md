# æ€»åŒ…æ–½å·¥ç®¡ç† - ç¼–è¾‘ä¸è”åŠ¨å®Œæ•´æ–¹æ¡ˆ

## ğŸ¯ éœ€æ±‚åˆ†æ

### ç”¨æˆ·é—®é¢˜
1. **æ€»åŒ…æ–½å·¥ç®¡ç†çš„æ¯ä¸ªé˜¶æ®µæ€ä¹ˆç¼–è¾‘ï¼Ÿ**
2. **æ€ä¹ˆå’Œå…¶ä»–æ¨¡å—è”åŠ¨ï¼Ÿ**

---

## ğŸ“‹ æ–¹æ¡ˆè®¾è®¡

### 1ï¸âƒ£ é˜¶æ®µç¼–è¾‘åŠŸèƒ½

#### åŠŸèƒ½éœ€æ±‚
- âœ… ç¼–è¾‘é˜¶æ®µåŸºæœ¬ä¿¡æ¯ï¼ˆåç§°ã€è´Ÿè´£äººã€æ—¶é—´ï¼‰
- âœ… æ›´æ–°é˜¶æ®µè¿›åº¦
- âœ… æ·»åŠ /ç¼–è¾‘é‡Œç¨‹ç¢‘
- âœ… ç®¡ç†é˜¶æ®µä»»åŠ¡
- âœ… è®°å½•é£é™©å’Œé—®é¢˜

#### å®ç°æ–¹æ¡ˆ

**A. é˜¶æ®µçŠ¶æ€ç®¡ç†**
```typescript
// ConstructionManagement.tsx
const [epcPhases, setEpcPhases] = useState([...]);
const [editingPhase, setEditingPhase] = useState<any>(null);
const [isPhaseModalVisible, setIsPhaseModalVisible] = useState(false);

// ç¼–è¾‘é˜¶æ®µ
const handleEditPhase = (phase: any) => {
  setEditingPhase(phase);
  setIsPhaseModalVisible(true);
};

// ä¿å­˜é˜¶æ®µ
const handleSavePhase = async (values: any) => {
  const updatedPhases = epcPhases.map(p => 
    p.key === editingPhase.key ? { ...p, ...values } : p
  );
  setEpcPhases(updatedPhases);
  
  // ğŸ”— è”åŠ¨ï¼šæ›´æ–°é¡¹ç›®è¿›åº¦
  await updateProjectProgress(currentProject.id, calculateOverallProgress(updatedPhases));
  
  setIsPhaseModalVisible(false);
};
```

**B. é˜¶æ®µç¼–è¾‘è¡¨å•**
```typescript
<Modal
  title={`ç¼–è¾‘é˜¶æ®µ - ${editingPhase?.name}`}
  open={isPhaseModalVisible}
  onOk={() => form.submit()}
  onCancel={() => setIsPhaseModalVisible(false)}
  width={800}
>
  <Form form={form} onFinish={handleSavePhase}>
    <Form.Item label="é˜¶æ®µåç§°" name="name">
      <Input />
    </Form.Item>
    
    <Form.Item label="è´Ÿè´£äºº" name="responsible">
      <Input />
    </Form.Item>
    
    <Form.Item label="è¿›åº¦" name="progress">
      <Slider min={0} max={100} marks={{ 0: '0%', 50: '50%', 100: '100%' }} />
    </Form.Item>
    
    <Form.Item label="å¼€å§‹æ—¥æœŸ" name="startDate">
      <DatePicker />
    </Form.Item>
    
    <Form.Item label="ç»“æŸæ—¥æœŸ" name="endDate">
      <DatePicker />
    </Form.Item>
    
    <Form.Item label="å›¢é˜Ÿæˆå‘˜" name="team">
      <Select mode="tags" placeholder="æ·»åŠ å›¢é˜Ÿæˆå‘˜" />
    </Form.Item>
    
    <Form.Item label="äº¤ä»˜ç‰©" name="deliverables">
      <Select mode="tags" placeholder="æ·»åŠ äº¤ä»˜ç‰©" />
    </Form.Item>
  </Form>
</Modal>
```

---

### 2ï¸âƒ£ æ¨¡å—è”åŠ¨åŠŸèƒ½

#### A. ä¸é¡¹ç›®è¿›åº¦è”åŠ¨ ğŸ”—

**éœ€æ±‚**: é˜¶æ®µè¿›åº¦å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°é¡¹ç›®æ€»è¿›åº¦

**å®ç°**:
```typescript
// è®¡ç®—é¡¹ç›®æ€»è¿›åº¦ï¼ˆåŠ æƒå¹³å‡ï¼‰
const calculateOverallProgress = (phases: any[]) => {
  const weights = {
    'design': 0.15,      // è®¾è®¡ 15%
    'procurement': 0.20, // é‡‡è´­ 20%
    'construction': 0.40,// æ–½å·¥ 40%
    'commissioning': 0.15,// è°ƒè¯• 15%
    'acceptance': 0.10   // éªŒæ”¶ 10%
  };
  
  return phases.reduce((total, phase) => {
    return total + (phase.progress * (weights[phase.key] || 0));
  }, 0);
};

// æ›´æ–°é¡¹ç›®è¿›åº¦
const updateProjectProgress = async (projectId: string, progress: number) => {
  await fetch(`${API_ENDPOINTS.projects}/${projectId}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ progress })
  });
  
  // åˆ·æ–°é¡¹ç›®ä¸Šä¸‹æ–‡
  await loadProjects();
  
  notification.success({ message: `é¡¹ç›®è¿›åº¦å·²æ›´æ–°ä¸º ${progress.toFixed(1)}%` });
};
```

---

#### B. ä¸ç”˜ç‰¹å›¾è”åŠ¨ ğŸ”—

**éœ€æ±‚**: 
1. é˜¶æ®µä»»åŠ¡è‡ªåŠ¨åŒæ­¥åˆ°ç”˜ç‰¹å›¾
2. ç”˜ç‰¹å›¾ä»»åŠ¡å®Œæˆæ—¶æ›´æ–°é˜¶æ®µè¿›åº¦

**å®ç°**:

**1. é˜¶æ®µä»»åŠ¡ â†’ ç”˜ç‰¹å›¾**
```typescript
// å°†é˜¶æ®µä»»åŠ¡åŒæ­¥åˆ°ç”˜ç‰¹å›¾
const syncPhaseTasksToGantt = async (phase: any) => {
  const ganttTasks = phase.tasks.map((task: any, index: number) => ({
    id: `${currentProject.id}-${phase.key}-TASK-${index + 1}`,
    name: task.name,
    start_date: phase.startDate,
    duration: Math.ceil(dayjs(phase.endDate).diff(dayjs(phase.startDate), 'day') / phase.tasks.length),
    progress: task.progress / 100,
    assignee: phase.responsible,
    priority: 'high',
    project_id: currentProject.id,
    phase_key: phase.key  // ğŸ”— å…³è”é˜¶æ®µ
  }));
  
  // æ‰¹é‡åˆ›å»ºç”˜ç‰¹å›¾ä»»åŠ¡
  for (const task of ganttTasks) {
    await fetch(API_ENDPOINTS.tasks, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(task)
    });
  }
  
  notification.success({ message: `å·²å°† ${ganttTasks.length} ä¸ªä»»åŠ¡åŒæ­¥åˆ°ç”˜ç‰¹å›¾` });
};
```

**2. ç”˜ç‰¹å›¾ â†’ é˜¶æ®µè¿›åº¦**
```typescript
// DhtmlxGanttChart.tsx
gantt.attachEvent('onAfterTaskUpdate', (id: any, item: any) => {
  // å¦‚æœä»»åŠ¡å…³è”äº†é˜¶æ®µï¼Œæ›´æ–°é˜¶æ®µè¿›åº¦
  if (item.phase_key) {
    updatePhaseProgressFromGantt(item.phase_key);
  }
  return true;
});

// ConstructionManagement.tsx
const updatePhaseProgressFromGantt = async (phaseKey: string) => {
  // è·å–è¯¥é˜¶æ®µçš„æ‰€æœ‰ç”˜ç‰¹å›¾ä»»åŠ¡
  const response = await fetch(
    `${API_ENDPOINTS.tasks}?project_id=${currentProject.id}&phase_key=${phaseKey}`
  );
  const tasks = await response.json();
  
  // è®¡ç®—å¹³å‡è¿›åº¦
  const avgProgress = tasks.reduce((sum: number, t: any) => sum + (t.progress || 0), 0) / tasks.length;
  
  // æ›´æ–°é˜¶æ®µè¿›åº¦
  const updatedPhases = epcPhases.map(p => 
    p.key === phaseKey ? { ...p, progress: Math.round(avgProgress * 100) } : p
  );
  setEpcPhases(updatedPhases);
  
  // æ›´æ–°é¡¹ç›®æ€»è¿›åº¦
  await updateProjectProgress(currentProject.id, calculateOverallProgress(updatedPhases));
};
```

---

#### C. ä¸æ–½å·¥æ—¥å¿—è”åŠ¨ ğŸ”—

**éœ€æ±‚**: æ–½å·¥æ—¥å¿—è‡ªåŠ¨å…³è”åˆ°å½“å‰æ–½å·¥é˜¶æ®µ

**å®ç°**:
```typescript
// ConstructionLog.tsx
const handleSaveLog = async (values: any) => {
  // è‡ªåŠ¨å…³è”åˆ°å½“å‰æ–½å·¥é˜¶æ®µ
  const currentPhase = getCurrentConstructionPhase(); // ä»ConstructionManagementè·å–
  
  const logData = {
    ...values,
    project_id: currentProject.id,
    phase_key: currentPhase?.key,  // ğŸ”— å…³è”é˜¶æ®µ
    phase_name: currentPhase?.name,
  };
  
  await fetch(API_ENDPOINTS.constructionLogs, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(logData)
  });
};

// åœ¨ConstructionManagementä¸­æ˜¾ç¤ºå…³è”çš„æ—¥å¿—
const getPhaseConstructionLogs = async (phaseKey: string) => {
  const response = await fetch(
    `${API_ENDPOINTS.constructionLogs}?project_id=${currentProject.id}&phase_key=${phaseKey}`
  );
  return await response.json();
};
```

---

#### D. ä¸è®¾å¤‡ç®¡ç†è”åŠ¨ ğŸ”—

**éœ€æ±‚**: é‡‡è´­é˜¶æ®µè¿›åº¦ä¸è®¾å¤‡åˆ°è´§çŠ¶æ€è”åŠ¨

**å®ç°**:
```typescript
// è®¡ç®—é‡‡è´­é˜¶æ®µè¿›åº¦ï¼ˆåŸºäºè®¾å¤‡åˆ°è´§ç‡ï¼‰
const updateProcurementProgressFromDevices = async () => {
  const response = await fetch(
    `${API_ENDPOINTS.devices}?project_id=${currentProject.id}`
  );
  const devices = await response.json();
  
  // è®¡ç®—è®¾å¤‡åˆ°è´§ç‡
  const arrivedCount = devices.filter((d: any) => 
    d.status === 'installed' || d.status === 'installing'
  ).length;
  const arrivalRate = (arrivedCount / devices.length) * 100;
  
  // æ›´æ–°é‡‡è´­é˜¶æ®µè¿›åº¦
  const updatedPhases = epcPhases.map(p => 
    p.key === 'procurement' ? { ...p, progress: Math.round(arrivalRate) } : p
  );
  setEpcPhases(updatedPhases);
  
  notification.info({ message: `é‡‡è´­è¿›åº¦å·²æ›´æ–°: ${arrivalRate.toFixed(1)}%` });
};
```

---

## ğŸ”„ å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ€»åŒ…æ–½å·¥ç®¡ç† (EPC Phases)                   â”‚
â”‚  - è®¾è®¡é˜¶æ®µ (15%)                                            â”‚
â”‚  - é‡‡è´­é˜¶æ®µ (20%) â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚  - æ–½å·¥é˜¶æ®µ (40%) â†â”€â”€â”€â”€â”€â”   â”‚                               â”‚
â”‚  - è°ƒè¯•é˜¶æ®µ (15%)       â”‚   â”‚                               â”‚
â”‚  - éªŒæ”¶é˜¶æ®µ (10%)       â”‚   â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚               â”‚   â”‚
          â”‚ åŠ æƒå¹³å‡      â”‚   â”‚ è®¾å¤‡åˆ°è´§ç‡
          â–¼               â”‚   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  é¡¹ç›®æ€»è¿›åº¦     â”‚       â”‚   â”‚
â”‚  (Project)      â”‚       â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
                          â”‚   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                                    â”‚
          â–¼                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”˜ç‰¹å›¾ä»»åŠ¡     â”‚                  â”‚  è®¾å¤‡ç®¡ç†       â”‚
â”‚  (Gantt Tasks)  â”‚                  â”‚  (Devices)      â”‚
â”‚  - phase_key    â”‚                  â”‚  - status       â”‚
â”‚  - progress     â”‚                  â”‚  - arrival_date â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”‚ ä»»åŠ¡è¿›åº¦
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–½å·¥æ—¥å¿—       â”‚
â”‚  (Logs)         â”‚
â”‚  - phase_key    â”‚
â”‚  - task_id      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ å®æ–½æ­¥éª¤

### é˜¶æ®µ1: æ·»åŠ é˜¶æ®µç¼–è¾‘åŠŸèƒ½ âœ…

**æ–‡ä»¶**: `client/src/pages/ConstructionManagement.tsx`

```typescript
// 1. æ·»åŠ çŠ¶æ€ç®¡ç†
const [epcPhases, setEpcPhases] = useState([...]);
const [editingPhase, setEditingPhase] = useState<any>(null);
const [isPhaseModalVisible, setIsPhaseModalVisible] = useState(false);
const [form] = Form.useForm();

// 2. æ·»åŠ ç¼–è¾‘æŒ‰é’®
<Button 
  icon={<EditOutlined />} 
  onClick={() => handleEditPhase(phase)}
>
  ç¼–è¾‘é˜¶æ®µ
</Button>

// 3. æ·»åŠ ç¼–è¾‘Modalï¼ˆè§ä¸Šæ–‡ï¼‰
```

---

### é˜¶æ®µ2: å®ç°é¡¹ç›®è¿›åº¦è”åŠ¨ âœ…

```typescript
// é˜¶æ®µè¿›åº¦å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°é¡¹ç›®è¿›åº¦
const handlePhaseProgressChange = async (phaseKey: string, newProgress: number) => {
  const updatedPhases = epcPhases.map(p => 
    p.key === phaseKey ? { ...p, progress: newProgress } : p
  );
  setEpcPhases(updatedPhases);
  
  const overallProgress = calculateOverallProgress(updatedPhases);
  await updateProjectProgress(currentProject.id, overallProgress);
};
```

---

### é˜¶æ®µ3: å®ç°ç”˜ç‰¹å›¾è”åŠ¨ ğŸ”„

**éœ€è¦åç«¯æ”¯æŒ**: 
- `tasks` è¡¨æ·»åŠ  `phase_key` å­—æ®µ
- APIæ”¯æŒæŒ‰ `phase_key` è¿‡æ»¤

```sql
ALTER TABLE tasks ADD COLUMN phase_key TEXT;
```

---

### é˜¶æ®µ4: å®ç°æ–½å·¥æ—¥å¿—è”åŠ¨ ğŸ”„

**éœ€è¦åç«¯æ”¯æŒ**:
- `construction_logs` è¡¨æ·»åŠ  `phase_key` å­—æ®µ

```sql
ALTER TABLE construction_logs ADD COLUMN phase_key TEXT;
```

---

### é˜¶æ®µ5: å®ç°è®¾å¤‡ç®¡ç†è”åŠ¨ ğŸ”„

**é€»è¾‘**: 
- ç›‘å¬è®¾å¤‡çŠ¶æ€å˜åŒ–
- è‡ªåŠ¨è®¡ç®—é‡‡è´­é˜¶æ®µè¿›åº¦

---

## ğŸ¯ å¿«é€Ÿå®ç°ï¼ˆç«‹å³å¯ç”¨ï¼‰

### æœ€å°å¯è¡Œæ–¹æ¡ˆï¼ˆä¸éœ€è¦åç«¯ï¼‰

```typescript
// ConstructionManagement.tsx

// 1. æ·»åŠ ç¼–è¾‘åŠŸèƒ½
const [epcPhases, setEpcPhases] = useState([...]); // æ”¹ä¸ºstate
const [editingPhase, setEditingPhase] = useState<any>(null);
const [isModalVisible, setIsModalVisible] = useState(false);
const [form] = Form.useForm();

// 2. ç¼–è¾‘å¤„ç†
const handleEdit = (phase: any) => {
  setEditingPhase(phase);
  form.setFieldsValue(phase);
  setIsModalVisible(true);
};

const handleSave = (values: any) => {
  const updated = epcPhases.map(p => 
    p.key === editingPhase.key ? { ...p, ...values } : p
  );
  setEpcPhases(updated);
  setIsModalVisible(false);
  
  // ğŸ”— è”åŠ¨ï¼šæ›´æ–°é¡¹ç›®è¿›åº¦
  const progress = calculateOverallProgress(updated);
  message.success(`é˜¶æ®µå·²æ›´æ–°ï¼Œé¡¹ç›®è¿›åº¦: ${progress.toFixed(1)}%`);
};

// 3. åœ¨UIä¸­æ·»åŠ ç¼–è¾‘æŒ‰é’®
<Button icon={<EditOutlined />} onClick={() => handleEdit(phase)}>
  ç¼–è¾‘
</Button>
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡¹ç›®æ•°æ®éš”ç¦»ä¸è”åŠ¨æ¶æ„æ–¹æ¡ˆ.md](./é¡¹ç›®æ•°æ®éš”ç¦»ä¸è”åŠ¨æ¶æ„æ–¹æ¡ˆ.md)
- [âœ…é¡¹ç›®æ•°æ®éš”ç¦»ä¿®å¤å®Œæˆ.md](./âœ…é¡¹ç›®æ•°æ®éš”ç¦»ä¿®å¤å®Œæˆ.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-26  
**çŠ¶æ€**: è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½



