# EPC项目管理系统 - 双模式部署说明

## 🎯 系统架构特点

本系统采用**前后端分离 + 双模式部署**架构，支持：
1. **本地桌面版**：数据本地SQLite，离线可用
2. **在线部署版**：数据服务器PostgreSQL/MySQL，多人协作

## 📊 两种模式对比

| 特性 | 本地桌面版 | 在线部署版 |
|------|-----------|-----------|
| **数据存储** | SQLite本地文件 | PostgreSQL/MySQL服务器 |
| **网络需求** | 无需网络 | 需要网络 |
| **多人协作** | 单人使用 | 多人同时访问 |
| **数据安全** | 本地完全可控 | 需配置服务器安全 |
| **部署难度** | 极简（一键启动） | 需配置服务器 |
| **适用场景** | 个人/单机/离线 | 团队/多地/云端 |

## 🚀 本地桌面版使用

### 方式1：开发模式（当前）
```bash
# 运行启动脚本
启动系统-本地版.bat

# 自动完成：
# 1. 启动后端 (http://localhost:8000)
# 2. 启动前端 (http://localhost:3001)
# 3. 打开浏览器
```

**数据位置**：
- Windows: `C:\Users\{用户名}\AppData\Roaming\EPC项目管理系统\database\epc_data.db`
- macOS: `~/Library/Application Support/EPC项目管理系统/database/epc_data.db`
- Linux: `~/.config/EPC项目管理系统/database/epc_data.db`

### 方式2：桌面应用（推荐）
```bash
# 1. 构建前端
cd client && npm run build

# 2. 打包Electron
cd .. && npm run package:win

# 3. 安装
# 双击 release/EPC项目管理系统 Setup 1.0.0.exe
```

**优势**：
- 一键启动，无需命令行
- 独立.exe程序
- 自带Python环境
- 数据独立存储

## 🌐 在线部署版使用

### 部署架构
```
用户浏览器
    ↓
Nginx (80/443)
    ↓
前端静态文件 (React build)
    ↓
后端API (FastAPI + PostgreSQL)
```

### 部署步骤

#### 1. 准备服务器
```bash
# 云服务器（阿里云/腾讯云/AWS等）
# 推荐配置：2核4G，Ubuntu 20.04
```

#### 2. 安装依赖
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# 安装Python
sudo apt install -y python3.9 python3.9-venv python3-pip

# 安装PostgreSQL
sudo apt install -y postgresql postgresql-contrib

# 安装Nginx
sudo apt install -y nginx
```

#### 3. 配置数据库
```bash
# 创建数据库和用户
sudo -u postgres psql
CREATE DATABASE epc_management;
CREATE USER epc_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE epc_management TO epc_user;
\q
```

#### 4. 修改后端配置
```python
# server/app/core/config.py
import os

class Settings:
    # 数据库配置
    DATABASE_URL = os.getenv(
        "DATABASE_URL",
        "postgresql://epc_user:your_secure_password@localhost/epc_management"
    )
    
    # 如果是SQLite（本地模式）
    # DATABASE_URL = "sqlite:///./epc_data.db"
    
    # API配置
    API_V1_STR = "/api/v1"
    PROJECT_NAME = "EPC项目管理系统"
    
    # CORS配置
    BACKEND_CORS_ORIGINS = [
        "http://localhost:3001",      # 本地开发
        "http://your-domain.com",     # 生产域名
        "https://your-domain.com"
    ]
```

#### 5. 部署后端
```bash
# 上传代码到服务器
cd /var/www/epc-system/server

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 使用 Gunicorn 运行
gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker -b 127.0.0.1:8000
```

#### 6. 配置前端
```javascript
// client/src/config.ts
const PROD_API_URL = 'https://your-domain.com/api';  // 修改为实际域名

export const API_BASE_URL = process.env.NODE_ENV === 'production' 
  ? PROD_API_URL 
  : 'http://localhost:8000';
```

#### 7. 构建前端
```bash
cd client
npm install
npm run build

# 将 build 目录内容上传到服务器
# /var/www/epc-system/client/build/
```

#### 8. 配置Nginx
```nginx
# /etc/nginx/sites-available/epc-system
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /var/www/epc-system/client/build;
        try_files $uri $uri/ /index.html;
    }

    # 后端API代理
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API文档
    location /docs {
        proxy_pass http://127.0.0.1:8000/docs;
    }
}
```

启用站点：
```bash
sudo ln -s /etc/nginx/sites-available/epc-system /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 9. 配置HTTPS（推荐）
```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo certbot renew --dry-run
```

#### 10. 配置systemd服务（开机自启）
```ini
# /etc/systemd/system/epc-backend.service
[Unit]
Description=EPC项目管理系统后端
After=network.target postgresql.service

[Service]
Type=notify
User=www-data
WorkingDirectory=/var/www/epc-system/server
Environment="PATH=/var/www/epc-system/server/venv/bin"
ExecStart=/var/www/epc-system/server/venv/bin/gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker -b 127.0.0.1:8000
Restart=always

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable epc-backend
sudo systemctl start epc-backend
sudo systemctl status epc-backend
```

## 🔄 模式切换方法

### 从本地切换到在线
1. 修改 `client/src/config.ts` 中的 `PROD_API_URL`
2. 运行 `npm run build` 重新构建
3. 部署到服务器

### 从在线切换到本地
1. 数据导出：
   ```bash
   # 从PostgreSQL导出
   pg_dump epc_management > backup.sql
   
   # 导入到SQLite（需转换工具）
   # 或在应用中通过API导出为JSON，再导入本地
   ```

2. 恢复到本地：
   ```bash
   # 使用数据库管理页面的导入功能
   # 或直接替换 SQLite 文件
   ```

## 💾 数据迁移方案

### 本地 → 在线
```python
# server/scripts/migrate_local_to_cloud.py
import sqlite3
import psycopg2

# 连接本地SQLite
sqlite_conn = sqlite3.connect('path/to/epc_data.db')
sqlite_cursor = sqlite_conn.cursor()

# 连接云端PostgreSQL
pg_conn = psycopg2.connect(
    "postgresql://user:password@host/database"
)
pg_cursor = pg_conn.cursor()

# 迁移数据
tables = ['projects', 'tasks', 'devices', 'documents']
for table in tables:
    sqlite_cursor.execute(f"SELECT * FROM {table}")
    rows = sqlite_cursor.fetchall()
    
    # 插入到PostgreSQL
    for row in rows:
        pg_cursor.execute(f"INSERT INTO {table} VALUES (...)")
    
pg_conn.commit()
```

### 在线 → 本地
```python
# 反向操作，从PostgreSQL导出到SQLite
```

## 📊 推荐使用场景

### 本地桌面版适用：
- ✅ 个人项目管理
- ✅ 单机使用
- ✅ 离线环境
- ✅ 数据敏感项目
- ✅ 无需多人协作

### 在线部署版适用：
- ✅ 团队协作
- ✅ 多地办公
- ✅ 需要远程访问
- ✅ 数据集中管理
- ✅ 移动端访问需求

## 🔒 安全建议

### 本地版
- 定期备份数据库文件
- 加密敏感数据
- 设置登录密码

### 在线版
- 使用HTTPS（SSL证书）
- 配置防火墙规则
- 定期更新系统和依赖
- 数据库定期备份
- 启用日志审计
- 限制API访问频率

## 📝 总结

✅ **双模式支持**：一套代码，本地和在线都可用
✅ **灵活切换**：仅需修改配置文件
✅ **数据迁移**：提供迁移脚本
✅ **渐进式部署**：先本地试用，再在线部署

---

**当前系统已完全支持双模式，建议先用本地版验证功能，再考虑在线部署！**


