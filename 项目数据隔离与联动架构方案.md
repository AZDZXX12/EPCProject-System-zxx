# EPCé¡¹ç›®ç®¡ç†ç³»ç»Ÿ - æ•°æ®éš”ç¦»ä¸è”åŠ¨æ¶æ„æ–¹æ¡ˆ

## ğŸ”´ å½“å‰é—®é¢˜è¯Šæ–­

### 1. ç”˜ç‰¹å›¾ä»»åŠ¡IDå†²çª
**é—®é¢˜**: ä½¿ç”¨ `Date.now()` ç”Ÿæˆä»»åŠ¡IDï¼Œåˆ‡æ¢é¡¹ç›®åIDé‡å¤
```typescript
// âŒ é”™è¯¯åšæ³•
{ id: 1761372547038, text: 'é¡¹ç›®å¯åŠ¨', ... }  // é¡¹ç›®A
{ id: 1761372547038, text: 'è®¾å¤‡é‡‡è´­', ... }  // é¡¹ç›®B - IDå†²çªï¼
```

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `project_id` ä½œä¸ºå‰ç¼€
```typescript
// âœ… æ­£ç¡®åšæ³•
{ id: 'PROJ-001-TASK-1', text: 'é¡¹ç›®å¯åŠ¨', project_id: 'PROJ-001' }
{ id: 'PROJ-002-TASK-1', text: 'è®¾å¤‡é‡‡è´­', project_id: 'PROJ-002' }
```

---

### 2. æ•°æ®æœªæŒ‰é¡¹ç›®éš”ç¦»
**é—®é¢˜**: æ‰€æœ‰æ¨¡å—ï¼ˆç”˜ç‰¹å›¾ã€æ–½å·¥æ—¥å¿—ã€è®¾å¤‡ç®¡ç†ï¼‰å…±äº«æ•°æ®ï¼Œæ²¡æœ‰ `project_id` è¿‡æ»¤

**å½“å‰çŠ¶æ€**:
- âŒ `DhtmlxGanttChart.tsx`: åŠ è½½æ‰€æœ‰ä»»åŠ¡ï¼Œæœªè¿‡æ»¤ `project_id`
- âŒ `ConstructionLog.tsx`: æ–½å·¥æ—¥å¿—æœªä¸é¡¹ç›®å…³è”
- âŒ `DeviceManagement.tsx`: è®¾å¤‡æ•°æ®æœªéš”ç¦»

**è§£å†³æ–¹æ¡ˆ**: æ‰€æœ‰APIè¯·æ±‚å¿…é¡»æºå¸¦ `project_id`
```typescript
// âœ… æ­£ç¡®åšæ³•
GET /api/v1/tasks?project_id=PROJ-001
GET /api/v1/construction-logs?project_id=PROJ-001
GET /api/v1/devices?project_id=PROJ-001
```

---

### 3. æ¨¡å—é—´æ— è”åŠ¨
**é—®é¢˜**: æ–½å·¥æ—¥å¿—ã€ç”˜ç‰¹å›¾ã€æ€»åŒ…ç®¡ç†å„è‡ªç‹¬ç«‹ï¼Œæ— æ•°æ®å…³è”

**éœ€æ±‚**:
1. **æ–½å·¥æ—¥å¿— â†” ç”˜ç‰¹å›¾**: æ—¥å¿—æ¡ç›®åº”å…³è”åˆ°ç”˜ç‰¹å›¾ä»»åŠ¡
2. **æ€»åŒ…æ–½å·¥ç®¡ç† â†” é¡¹ç›®**: EPCæµç¨‹é˜¶æ®µåº”ä¸é¡¹ç›®è¿›åº¦åŒæ­¥
3. **è®¾å¤‡ç®¡ç† â†” é‡‡è´­é˜¶æ®µ**: è®¾å¤‡çŠ¶æ€åº”å½±å“é‡‡è´­é˜¶æ®µè¿›åº¦

**è§£å†³æ–¹æ¡ˆ**: å»ºç«‹æ•°æ®å…³è”
```typescript
// æ–½å·¥æ—¥å¿—å…³è”ç”˜ç‰¹å›¾ä»»åŠ¡
interface ConstructionLog {
  id: string;
  project_id: string;
  task_id?: string;  // å…³è”ç”˜ç‰¹å›¾ä»»åŠ¡
  date: string;
  content: string;
  weather: string;
  workers: number;
}

// ç”˜ç‰¹å›¾ä»»åŠ¡å…³è”æ–½å·¥æ—¥å¿—
interface GanttTask {
  id: string;
  project_id: string;
  text: string;
  progress: number;
  logs: ConstructionLog[];  // å…³è”çš„æ–½å·¥æ—¥å¿—
}
```

---

### 4. åç«¯æ•°æ®åº“ç¼ºå°‘å…³è”è¡¨
**é—®é¢˜**: `sqlite-server.py` å’Œ `database.py` æ²¡æœ‰ `construction_logs` è¡¨

**å½“å‰æ•°æ®åº“è¡¨**:
- âœ… `projects`
- âœ… `tasks`
- âœ… `devices`
- âŒ `construction_logs` (ç¼ºå¤±)

**è§£å†³æ–¹æ¡ˆ**: æ‰©å±•æ•°æ®åº“Schema

---

## ğŸ¯ å®Œæ•´è§£å†³æ–¹æ¡ˆ

### é˜¶æ®µ1: ä¿®å¤ç”˜ç‰¹å›¾ä»»åŠ¡IDå†²çª âœ…

**æ–‡ä»¶**: `client/src/pages/DhtmlxGanttChart.tsx`

```typescript
// ä¿®æ”¹ loadTasks å‡½æ•°ä¸­çš„æœ¬åœ°æ•°æ®IDç”Ÿæˆ
const mockData = {
  data: [
    { 
      id: `${currentProject.id}-TASK-1`,  // âœ… ä½¿ç”¨é¡¹ç›®IDå‰ç¼€
      text: 'é¡¹ç›®å¯åŠ¨', 
      start_date: '2025-01-01', 
      duration: 5, 
      progress: 1, 
      project_id: currentProject.id  // âœ… æ·»åŠ é¡¹ç›®IDå­—æ®µ
    },
    // ...
  ],
  links: []
};
```

---

### é˜¶æ®µ2: å®ç°æ•°æ®æŒ‰é¡¹ç›®éš”ç¦» âœ…

**1. ç”˜ç‰¹å›¾ (DhtmlxGanttChart.tsx)**
```typescript
// åŠ è½½ä»»åŠ¡æ—¶å¼ºåˆ¶è¿‡æ»¤ project_id
const loadTasks = async () => {
  if (!currentProject) {
    notification.warning({ message: 'è¯·å…ˆé€‰æ‹©é¡¹ç›®' });
    return;
  }
  
  const response = await fetchWithTimeout(
    `${API_ENDPOINTS.tasks}?project_id=${currentProject.id}`,
    {}, 
    5000
  );
  // ...
};
```

**2. æ–½å·¥æ—¥å¿— (ConstructionLog.tsx)**
```typescript
const loadLogs = async () => {
  if (!currentProject) return;
  
  const response = await fetch(
    `${API_ENDPOINTS.constructionLogs}?project_id=${currentProject.id}`
  );
  // ...
};
```

**3. è®¾å¤‡ç®¡ç† (DeviceManagement.tsx)**
```typescript
const loadDevices = async () => {
  if (!currentProject) return;
  
  const response = await fetch(
    `${API_ENDPOINTS.devices}?project_id=${currentProject.id}`
  );
  // ...
};
```

---

### é˜¶æ®µ3: å®ç°æ–½å·¥æ—¥å¿—ä¸ç”˜ç‰¹å›¾è”åŠ¨ ğŸ”„

**éœ€æ±‚**: 
1. åœ¨æ–½å·¥æ—¥å¿—ä¸­é€‰æ‹©å…³è”çš„ç”˜ç‰¹å›¾ä»»åŠ¡
2. åœ¨ç”˜ç‰¹å›¾ä»»åŠ¡è¯¦æƒ…ä¸­æ˜¾ç¤ºç›¸å…³æ–½å·¥æ—¥å¿—
3. æ–½å·¥æ—¥å¿—æ›´æ–°æ—¶è‡ªåŠ¨æ›´æ–°ä»»åŠ¡è¿›åº¦

**å®ç°**:

**1. æ‰©å±•æ–½å·¥æ—¥å¿—è¡¨å• (ConstructionLog.tsx)**
```typescript
<Form.Item label="å…³è”ä»»åŠ¡" name="task_id">
  <Select
    placeholder="é€‰æ‹©å…³è”çš„ç”˜ç‰¹å›¾ä»»åŠ¡"
    allowClear
    options={ganttTasks.map(task => ({
      label: task.text,
      value: task.id
    }))}
  />
</Form.Item>
```

**2. ç”˜ç‰¹å›¾ä»»åŠ¡è¯¦æƒ…æ˜¾ç¤ºæ—¥å¿— (DhtmlxGanttChart.tsx)**
```typescript
// åœ¨ lightbox ä¸­æ·»åŠ "æ–½å·¥æ—¥å¿—"æ ‡ç­¾é¡µ
gantt.config.lightbox.sections = [
  // ... ç°æœ‰å­—æ®µ
  {
    name: 'logs',
    height: 200,
    type: 'template',
    map_to: 'logs',
    template: (task: any) => {
      const logs = task.logs || [];
      return `
        <div>
          <h4>å…³è”æ–½å·¥æ—¥å¿— (${logs.length}æ¡)</h4>
          ${logs.map(log => `
            <div style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
              <b>${log.date}</b>: ${log.content}
            </div>
          `).join('')}
        </div>
      `;
    }
  }
];
```

---

### é˜¶æ®µ4: æ€»åŒ…æ–½å·¥ç®¡ç†ä¸é¡¹ç›®è”åŠ¨ ğŸ”„

**éœ€æ±‚**: 
1. `ConstructionManagement.tsx` çš„EPCæµç¨‹é˜¶æ®µåº”ä¸ `currentProject` çš„è¿›åº¦åŒæ­¥
2. é˜¶æ®µå®Œæˆåº¦åº”è‡ªåŠ¨è®¡ç®—å¹¶æ›´æ–°é¡¹ç›®è¿›åº¦

**å®ç°**:

**1. ä»é¡¹ç›®æ•°æ®ä¸­è¯»å–EPCé˜¶æ®µè¿›åº¦**
```typescript
// ConstructionManagement.tsx
const { currentProject } = useProject();

// æ ¹æ®é¡¹ç›®è¿›åº¦åŠ¨æ€è®¡ç®—å½“å‰é˜¶æ®µ
const getCurrentPhase = () => {
  if (!currentProject) return null;
  const progress = currentProject.progress || 0;
  
  if (progress < 20) return 'design';
  if (progress < 40) return 'procurement';
  if (progress < 70) return 'construction';
  if (progress < 90) return 'commissioning';
  return 'acceptance';
};

const currentPhase = getCurrentPhase();
```

**2. é˜¶æ®µå®Œæˆæ—¶æ›´æ–°é¡¹ç›®è¿›åº¦**
```typescript
const handlePhaseComplete = async (phaseName: string) => {
  // è®¡ç®—æ–°çš„é¡¹ç›®è¿›åº¦
  const phaseProgress = {
    'design': 20,
    'procurement': 40,
    'construction': 70,
    'commissioning': 90,
    'acceptance': 100
  };
  
  const newProgress = phaseProgress[phaseName];
  
  // æ›´æ–°é¡¹ç›®è¿›åº¦
  await fetch(`${API_ENDPOINTS.projects}/${currentProject.id}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      ...currentProject,
      progress: newProgress
    })
  });
  
  // åˆ·æ–°é¡¹ç›®æ•°æ®
  await loadProjects();
};
```

---

### é˜¶æ®µ5: åç«¯æ•°æ®åº“Schemaå‡çº§ ğŸ”„

**æ–‡ä»¶**: `server/database.py`

**1. æ·»åŠ  `construction_logs` è¡¨**
```python
def init_database(self):
    """åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„"""
    cursor = self.conn.cursor()
    
    # ... ç°æœ‰è¡¨ ...
    
    # æ–½å·¥æ—¥å¿—è¡¨
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS construction_logs (
            id TEXT PRIMARY KEY,
            project_id TEXT NOT NULL,
            task_id TEXT,  -- å…³è”ç”˜ç‰¹å›¾ä»»åŠ¡
            date TEXT NOT NULL,
            content TEXT,
            weather TEXT,
            temperature TEXT,
            workers INTEGER DEFAULT 0,
            equipment TEXT,
            materials TEXT,
            progress_description TEXT,
            issues TEXT,
            photos TEXT,  -- JSONæ•°ç»„å­˜å‚¨ç…§ç‰‡URL
            created_at TEXT DEFAULT CURRENT_TIMESTAMP,
            updated_at TEXT DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (project_id) REFERENCES projects(id),
            FOREIGN KEY (task_id) REFERENCES tasks(id)
        )
    ''')
    
    self.conn.commit()
```

**2. æ·»åŠ  CRUD æ–¹æ³•**
```python
def create_construction_log(self, log_data: dict) -> dict:
    """åˆ›å»ºæ–½å·¥æ—¥å¿—"""
    cursor = self.conn.cursor()
    log_id = log_data.get('id', f"LOG-{int(time.time() * 1000)}")
    
    cursor.execute('''
        INSERT INTO construction_logs 
        (id, project_id, task_id, date, content, weather, temperature, 
         workers, equipment, materials, progress_description, issues, photos)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    ''', (
        log_id,
        log_data['project_id'],
        log_data.get('task_id'),
        log_data['date'],
        log_data.get('content', ''),
        log_data.get('weather', ''),
        log_data.get('temperature', ''),
        log_data.get('workers', 0),
        log_data.get('equipment', ''),
        log_data.get('materials', ''),
        log_data.get('progress_description', ''),
        log_data.get('issues', ''),
        json.dumps(log_data.get('photos', []))
    ))
    
    self.conn.commit()
    return {**log_data, 'id': log_id}

def get_construction_logs(self, project_id: str = None) -> list:
    """è·å–æ–½å·¥æ—¥å¿—"""
    cursor = self.conn.cursor()
    
    if project_id:
        cursor.execute(
            'SELECT * FROM construction_logs WHERE project_id = ? ORDER BY date DESC',
            (project_id,)
        )
    else:
        cursor.execute('SELECT * FROM construction_logs ORDER BY date DESC')
    
    columns = [desc[0] for desc in cursor.description]
    return [dict(zip(columns, row)) for row in cursor.fetchall()]
```

**æ–‡ä»¶**: `server/sqlite-server.py`

**3. æ·»åŠ APIç«¯ç‚¹**
```python
# ==================== æ–½å·¥æ—¥å¿— API ====================

@app.get("/api/v1/construction-logs/")
async def get_construction_logs(project_id: Optional[str] = None):
    """è·å–æ–½å·¥æ—¥å¿—"""
    logs = db.get_construction_logs(project_id)
    return logs

@app.post("/api/v1/construction-logs/")
async def create_construction_log(log: dict):
    """åˆ›å»ºæ–½å·¥æ—¥å¿—"""
    new_log = db.create_construction_log(log)
    return new_log

@app.put("/api/v1/construction-logs/{log_id}")
async def update_construction_log(log_id: str, log: dict):
    """æ›´æ–°æ–½å·¥æ—¥å¿—"""
    updated_log = db.update_construction_log(log_id, log)
    if not updated_log:
        raise HTTPException(status_code=404, detail="æ–½å·¥æ—¥å¿—ä¸å­˜åœ¨")
    return updated_log

@app.delete("/api/v1/construction-logs/{log_id}")
async def delete_construction_log(log_id: str):
    """åˆ é™¤æ–½å·¥æ—¥å¿—"""
    success = db.delete_construction_log(log_id)
    if not success:
        raise HTTPException(status_code=404, detail="æ–½å·¥æ—¥å¿—ä¸å­˜åœ¨")
    return {"message": "åˆ é™¤æˆåŠŸ"}
```

---

## ğŸ“Š æ•°æ®æµå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ProjectContext                          â”‚
â”‚  currentProject: { id, name, progress, status, ... }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚           â”‚           â”‚             â”‚
         â–¼           â–¼           â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”˜ç‰¹å›¾     â”‚ â”‚ æ–½å·¥æ—¥å¿— â”‚ â”‚ è®¾å¤‡ç®¡ç†â”‚ â”‚ æ€»åŒ…æ–½å·¥ç®¡ç†   â”‚
â”‚ (Tasks)    â”‚ â”‚ (Logs)   â”‚ â”‚(Devices)â”‚ â”‚ (EPC Phases)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚             â”‚              â”‚
     â”‚ project_id   â”‚ project_id  â”‚ project_id   â”‚ project_id
     â”‚              â”‚             â”‚              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  SQLiteæ•°æ®åº“  â”‚
            â”‚  - projects    â”‚
            â”‚  - tasks       â”‚
            â”‚  - devices     â”‚
            â”‚  - logs        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç«‹å³ä¿®å¤ï¼ˆä¼˜å…ˆçº§P0ï¼‰
1. âœ… ä¿®å¤ç”˜ç‰¹å›¾ä»»åŠ¡IDå†²çª - ä½¿ç”¨ `project_id` å‰ç¼€
2. âœ… æ·»åŠ é¡¹ç›®é€‰æ‹©æ£€æŸ¥ - æœªé€‰æ‹©é¡¹ç›®æ—¶ç¦æ­¢æ“ä½œ
3. âœ… æ¸…ç†é¡¹ç›®åˆ‡æ¢é€»è¾‘ - ç¡®ä¿æ•°æ®å®Œå…¨éš”ç¦»

### çŸ­æœŸä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§P1ï¼‰
4. ğŸ”„ åç«¯æ•°æ®åº“Schemaå‡çº§ - æ·»åŠ  `construction_logs` è¡¨
5. ğŸ”„ å®ç°æ–½å·¥æ—¥å¿—ä¸ç”˜ç‰¹å›¾è”åŠ¨
6. ğŸ”„ æ€»åŒ…æ–½å·¥ç®¡ç†ä¸é¡¹ç›®è¿›åº¦åŒæ­¥

### é•¿æœŸè§„åˆ’ï¼ˆä¼˜å…ˆçº§P2ï¼‰
7. ğŸ“‹ è®¾å¤‡ç®¡ç†ä¸é‡‡è´­é˜¶æ®µè”åŠ¨
8. ğŸ“‹ è´¨é‡æ£€æµ‹ä¸æ–½å·¥é˜¶æ®µå…³è”
9. ğŸ“‹ å®‰å…¨ç®¡ç†ä¸é¡¹ç›®é£é™©è”åŠ¨

---

## âœ… éªŒè¯æ¸…å•

- [ ] åˆ‡æ¢é¡¹ç›®åï¼Œç”˜ç‰¹å›¾æ˜¾ç¤ºæ­£ç¡®çš„ä»»åŠ¡
- [ ] åˆ‡æ¢é¡¹ç›®åï¼Œæ–½å·¥æ—¥å¿—æ˜¾ç¤ºæ­£ç¡®çš„è®°å½•
- [ ] åˆ‡æ¢é¡¹ç›®åï¼Œè®¾å¤‡åˆ—è¡¨æ˜¾ç¤ºæ­£ç¡®çš„è®¾å¤‡
- [ ] æ–°å»ºä»»åŠ¡æ—¶ï¼Œä»»åŠ¡IDåŒ…å«é¡¹ç›®IDå‰ç¼€
- [ ] æ–½å·¥æ—¥å¿—å¯ä»¥å…³è”åˆ°ç”˜ç‰¹å›¾ä»»åŠ¡
- [ ] æ€»åŒ…æ–½å·¥ç®¡ç†çš„é˜¶æ®µè¿›åº¦ä¸é¡¹ç›®è¿›åº¦åŒæ­¥
- [ ] æœªé€‰æ‹©é¡¹ç›®æ—¶ï¼Œæ˜¾ç¤ºå‹å¥½æç¤º

---

## ğŸ“ åç»­ä¼˜åŒ–å»ºè®®

1. **å®æ—¶æ•°æ®åŒæ­¥**: ä½¿ç”¨WebSocketå®ç°å¤šç”¨æˆ·ååŒ
2. **ç¦»çº¿æ¨¡å¼**: IndexedDBæœ¬åœ°ç¼“å­˜ï¼Œæ”¯æŒç¦»çº¿æ“ä½œ
3. **æ•°æ®å¯¼å…¥å¯¼å‡º**: æ”¯æŒExcelæ‰¹é‡å¯¼å…¥ä»»åŠ¡å’Œæ—¥å¿—
4. **ç§»åŠ¨ç«¯é€‚é…**: å“åº”å¼è®¾è®¡ï¼Œæ”¯æŒå¹³æ¿å’Œæ‰‹æœº
5. **æƒé™ç®¡ç†**: ä¸åŒè§’è‰²æŸ¥çœ‹ä¸åŒæ•°æ®èŒƒå›´

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-26  
**è´Ÿè´£äºº**: AI Assistant



