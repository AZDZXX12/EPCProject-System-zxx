# 📥 甘特图Excel导入功能使用说明

## ✨ 功能概述

交互式甘特图现已支持从Excel批量导入任务，并提供完整的任务列表管理功能：
- 📥 从Excel文件批量导入任务
- 📋 任务列表表格展示（可排序、筛选）
- 📄 PDF导出（避免中文乱码）
- 🔄 实时同步到后端数据库

---

## 🚀 快速开始

### 1️⃣ 下载Excel模板

1. 打开**施工进度甘特图**页面
2. 点击顶部工具栏的 **"下载模板"** 按钮
3. 系统自动下载 `EPC任务导入模板_YYYYMMDD.xlsx`

### 2️⃣ 填写任务数据

打开下载的Excel模板，按以下格式填写：

| 任务名称 | 开始日期 | 结束日期 | 负责人 | 优先级 | 状态 | 进度 |
|---------|---------|---------|--------|--------|------|------|
| R-001 反应釜安装 | 2024-01-05 | 2024-01-20 | 张工 | high | pending | 0 |
| P-002 泵类设备吊装 | 2024-01-21 | 2024-02-10 | 李工 | medium | in_progress | 50 |

**字段说明**：

| 字段 | 必填 | 格式 | 示例 | 说明 |
|------|------|------|------|------|
| 任务名称 | ✅ | 文本 | R-001 反应釜安装 | 任务的唯一标识名称 |
| 开始日期 | ✅ | YYYY-MM-DD | 2024-01-05 | 任务开始日期 |
| 结束日期 | ✅ | YYYY-MM-DD | 2024-01-20 | 任务结束日期（必须≥开始日期）|
| 负责人 | ❌ | 文本 | 张工 | 默认：未指定 |
| 优先级 | ❌ | high/medium/low | high | 默认：medium |
| 状态 | ❌ | pending/in_progress/completed<br/>或中文：待开始/进行中/已完成 | pending | 默认：pending |
| 进度 | ❌ | 0-100 | 50 | 默认：0 |

### 3️⃣ 导入Excel

1. 点击顶部工具栏的 **"导入Excel"** 按钮
2. 选择填写好的Excel文件
3. 系统自动解析并导入任务
4. 导入成功后，甘特图和任务列表自动更新

---

## 🎯 高级特性

### 支持中英文列名

系统智能识别以下列名（支持中英文混合）：

| 中文列名 | 英文列名 | 备用列名 |
|---------|---------|---------|
| 任务名称 | Task Name | name |
| 开始日期 | Start Date | start_date |
| 结束日期 | End Date | end_date |
| 负责人 | Assignee | assignee |
| 优先级 | Priority | priority |
| 状态 | Status | status |
| 进度 | Progress | progress |
| 项目ID | Project ID | - |

**示例**：以下三种格式都可以正确导入
```
✅ 中文：任务名称、开始日期、结束日期...
✅ 英文：Task Name、Start Date、End Date...
✅ 混合：name、start_date、end_date...
```

### 状态自动转换

系统自动将中文状态转换为英文：
- `待开始` → `pending`
- `进行中` → `in_progress`
- `已完成` → `completed`

### 数据验证

导入时自动进行以下验证：
1. ✅ 过滤表头行（避免重复导入列名）
2. ✅ 日期格式验证（无效日期使用当前日期）
3. ✅ 工期计算（结束日期必须≥开始日期）
4. ✅ 空任务过滤（忽略无任务名称的行）

---

## 📋 任务列表功能

### 表格特性

导入后的任务在列表中显示，支持：

| 功能 | 说明 |
|------|------|
| **排序** | 点击列头对开始日期、结束日期、工期、进度排序 |
| **筛选** | 按优先级、状态筛选任务 |
| **分页** | 支持10/20/50条/页切换 |
| **固定列** | 任务ID和名称固定在左侧，操作固定在右侧 |
| **进度条** | 可视化进度显示（0-100%） |
| **统计** | 顶部显示已完成/进行中/待开始任务数量 |

### 列说明

| 列名 | 宽度 | 说明 |
|------|------|------|
| 任务ID | 120px | 自动生成，蓝色标签显示 |
| 任务名称 | 200px | 可省略显示，hover查看完整内容 |
| 开始日期 | 120px | YYYY-MM-DD格式 |
| 结束日期 | 120px | YYYY-MM-DD格式 |
| 工期（天） | 100px | 自动计算，青色标签显示 |
| 负责人 | 100px | 责任人姓名 |
| 优先级 | 100px | 红色(高)/橙色(中)/灰色(低) |
| 状态 | 100px | 绿色(已完成)/蓝色(进行中)/灰色(待开始) |
| 进度 | 120px | 可视化进度条 + 百分比 |
| 操作 | 150px | 编辑/删除按钮 |

---

## 📄 PDF导出（已优化）

### 修复的乱码问题

**问题**：之前PDF中的中文全部显示为乱码  
**解决**：
1. ✅ 标题改为英文：`EPC Project Gantt Chart`
2. ✅ 表头改为英文：`Task Name`, `Start Date`, `End Date`...
3. ✅ 状态映射为英文：`Pending`, `In Progress`, `Completed`
4. ✅ 任务名称前加ID：便于识别（如 `T-001 反应釜安装`）

### PDF内容

导出的PDF包含：
- 📊 甘特图可视化（A3横向，高清）
- 📋 任务详细列表（完整信息表格）
- 📝 元数据（生成时间、任务总数、版本号）

---

## 🔄 实时联动

### 自动同步

- ⏱️ **自动刷新**：每30秒自动同步后端数据
- 🔄 **手动刷新**：点击工具栏"刷新"按钮立即同步
- 💾 **自动保存**：添加/编辑/删除任务立即同步到数据库

### 多用户协同

- 👥 支持多人同时查看和编辑
- 🔐 每个操作都需要用户登录认证
- 📊 所有改动实时反映在甘特图和列表中

---

## 💡 使用技巧

### Excel数据准备

✅ **推荐做法**：
- 使用模板文件填写（列名已规范）
- 日期格式统一为 `YYYY-MM-DD`
- 优先级使用小写：`high`, `medium`, `low`
- 状态可使用中文或英文

❌ **避免错误**：
- 不要修改模板的列名
- 不要在任务名称中使用特殊字符
- 确保日期逻辑正确（结束≥开始）
- 进度值必须在0-100之间

### 批量导入策略

1. **小批量测试**：先导入2-3条测试数据，确认格式正确
2. **增量导入**：多次导入会自动合并，不会覆盖现有任务
3. **备份数据**：在大批量导入前，先导出PDF或截图备份
4. **验证导入**：导入后检查任务列表，确认数据完整

### 性能优化

- 📊 单次导入建议不超过100条任务
- 🔄 大量任务时关闭自动刷新（暂时）
- 💾 导入完成后手动刷新查看最新数据

---

## 🐛 常见问题

### Q1: 导入后任务不显示？
**A**: 
1. 检查Excel是否有表头行（会被自动过滤）
2. 确认任务名称列不为空
3. 查看浏览器控制台是否有错误信息
4. 点击"刷新"按钮手动同步数据

### Q2: 日期显示不正确？
**A**: 
- Excel中的日期必须是 `YYYY-MM-DD` 格式
- 如果Excel显示为日期格式（如 `2024/1/5`），需转换为文本格式
- 推荐在Excel中使用 `TEXT()` 函数格式化日期

### Q3: 优先级/状态没有颜色？
**A**: 
- 检查Excel中的值是否为标准值（`high`/`medium`/`low` 或 `pending`/`in_progress`/`completed`）
- 系统默认值为 `medium` 和 `pending`

### Q4: PDF导出还是乱码？
**A**: 
- 最新版本已修复，使用英文标签
- 如仍有问题，请清除浏览器缓存后重试
- 任务名称会保留中文，但前面会加上任务ID

### Q5: 导入的任务没有同步到后端？
**A**: 
- 检查是否已登录（需要Bearer Token）
- 查看浏览器控制台网络请求是否成功
- 如果后端连接失败，任务会保存在本地（刷新后消失）

---

## 📝 更新日志

### v2.0.0-zxx (2024-10-18)

**新增功能**：
- ✅ Excel批量导入任务
- ✅ Excel模板下载
- ✅ 增强的任务列表（排序、筛选、统计）
- ✅ PDF导出优化（修复中文乱码）
- ✅ 实时数据同步（30秒自动刷新）

**修复问题**：
- 🐛 修复PDF中文乱码（改用英文标签）
- 🐛 修复任务添加后不显示（增加延迟重绘）
- 🐛 修复空任务列表时canvas高度错误
- 🐛 修复TypeScript类型错误（Task接口）

**优化改进**：
- 🎨 任务列表UI优化（进度条、标签颜色）
- 📊 增加任务统计（已完成/进行中/待开始）
- 🔍 支持任务按多种维度排序
- 🏷️ 优先级和状态筛选功能

---

## 📞 技术支持

- **开发团队**：EPC开发团队
- **版本号**：2.0.0-zxx
- **最后更新**：2024-10-18

**遇到问题？**
1. 查看浏览器控制台错误信息
2. 检查后端服务是否正常运行（`http://localhost:8000/docs`）
3. 参考本文档的常见问题章节
4. 联系技术支持团队

---

**提示**：首次使用建议先下载模板，熟悉数据格式后再进行大批量导入！



