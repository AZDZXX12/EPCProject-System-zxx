# EPC项目管理系统 - 桌面应用完整方案

## 🎯 核心架构

### 1. 技术栈
- **前端**: React + Ant Design (已完成)
- **后端**: FastAPI + SQLite (本地数据库)
- **打包**: Electron (桌面应用容器)
- **数据**: 本地 SQLite 数据库文件

### 2. 数据存储方案

#### SQLite 数据库位置
```
用户数据目录/
  └── EPC项目管理系统/
      ├── database/
      │   └── epc_data.db        # 主数据库
      ├── backup/
      │   └── epc_data_YYYYMMDD_HHMMSS.db  # 自动备份
      └── files/
          └── documents/         # 文档附件
```

**Windows**: `C:\Users\{用户名}\AppData\Roaming\EPC项目管理系统\`
**macOS**: `~/Library/Application Support/EPC项目管理系统/`
**Linux**: `~/.config/EPC项目管理系统/`

#### 数据表结构
```sql
-- 项目表
CREATE TABLE projects (
    id TEXT PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    status TEXT DEFAULT 'planning',
    progress INTEGER DEFAULT 0,
    budget REAL,
    start_date TEXT,
    end_date TEXT,
    manager TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 任务表
CREATE TABLE tasks (
    id TEXT PRIMARY KEY,
    project_id TEXT,
    name TEXT NOT NULL,
    description TEXT,
    start_date TEXT,
    end_date TEXT,
    progress REAL DEFAULT 0,
    status TEXT DEFAULT 'pending',
    assignee TEXT,
    priority TEXT DEFAULT 'medium',
    dependencies TEXT,  -- JSON array
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- 设备表
CREATE TABLE devices (
    id TEXT PRIMARY KEY,
    project_id TEXT,
    name TEXT NOT NULL,
    type TEXT,
    model TEXT,
    quantity INTEGER DEFAULT 1,
    unit_price REAL,
    total_price REAL,
    supplier TEXT,
    status TEXT DEFAULT 'planned',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- 文档表
CREATE TABLE documents (
    id TEXT PRIMARY KEY,
    project_id TEXT,
    name TEXT NOT NULL,
    type TEXT,
    file_path TEXT,
    size INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (project_id) REFERENCES projects(id)
);
```

## 🔧 实施步骤

### 阶段一：后端本地化 (1-2天)

#### 1. 创建 SQLite 数据库管理器
```python
# server/app/core/sqlite_manager.py
import sqlite3
from pathlib import Path
import os

class SQLiteManager:
    def __init__(self):
        # 获取用户数据目录
        if os.name == 'nt':  # Windows
            base_dir = Path(os.environ['APPDATA']) / 'EPC项目管理系统'
        else:  # macOS/Linux
            base_dir = Path.home() / '.config' / 'EPC项目管理系统'
        
        base_dir.mkdir(parents=True, exist_ok=True)
        self.db_path = base_dir / 'database' / 'epc_data.db'
        self.db_path.parent.mkdir(parents=True, exist_ok=True)
        
        self.init_database()
    
    def init_database(self):
        """初始化数据库表"""
        conn = sqlite3.connect(str(self.db_path))
        cursor = conn.cursor()
        
        # 创建projects表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS projects (
                id TEXT PRIMARY KEY,
                name TEXT NOT NULL,
                description TEXT,
                status TEXT DEFAULT 'planning',
                progress INTEGER DEFAULT 0,
                budget REAL,
                start_date TEXT,
                end_date TEXT,
                manager TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            )
        ''')
        
        # 创建tasks表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS tasks (
                id TEXT PRIMARY KEY,
                project_id TEXT,
                name TEXT NOT NULL,
                description TEXT,
                start_date TEXT,
                end_date TEXT,
                progress REAL DEFAULT 0,
                status TEXT DEFAULT 'pending',
                assignee TEXT,
                priority TEXT DEFAULT 'medium',
                dependencies TEXT,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (project_id) REFERENCES projects(id)
            )
        ''')
        
        # 创建devices表
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS devices (
                id TEXT PRIMARY KEY,
                project_id TEXT,
                name TEXT NOT NULL,
                type TEXT,
                model TEXT,
                quantity INTEGER DEFAULT 1,
                unit_price REAL,
                total_price REAL,
                supplier TEXT,
                status TEXT DEFAULT 'planned',
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                FOREIGN KEY (project_id) REFERENCES projects(id)
            )
        ''')
        
        conn.commit()
        conn.close()
        
        print(f"✅ 数据库初始化完成: {self.db_path}")
```

#### 2. 修改 FastAPI 后端使用 SQLite
```python
# server/main.py (简化版)
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.core.sqlite_manager import SQLiteManager
from app.api import projects, tasks, devices

app = FastAPI(title="EPC项目管理系统 API")

# 初始化数据库
db_manager = SQLiteManager()

# CORS配置
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# 注册路由
app.include_router(projects.router, prefix="/api/v1/projects", tags=["projects"])
app.include_router(tasks.router, prefix="/api/v1/tasks", tags=["tasks"])
app.include_router(devices.router, prefix="/api/v1/devices", tags=["devices"])

@app.get("/")
def read_root():
    return {
        "message": "EPC项目管理系统 API",
        "database": str(db_manager.db_path),
        "status": "running"
    }
```

### 阶段二：Electron 桌面应用打包 (1-2天)

#### 1. 创建 Electron 主进程
```javascript
// main.js (已优化)
const { app, BrowserWindow, ipcMain, dialog } = require('electron');
const path = require('path');
const { spawn } = require('child_process');

let mainWindow;
let backendProcess;

// 启动 Python 后端
function startBackend() {
    const pythonPath = path.join(__dirname, 'server', 'venv', 'Scripts', 'python.exe');
    const serverPath = path.join(__dirname, 'server', 'main.py');
    
    backendProcess = spawn(pythonPath, ['-m', 'uvicorn', 'main:app', '--port', '8000'], {
        cwd: path.join(__dirname, 'server'),
        stdio: 'inherit'
    });
    
    console.log('✅ 后端服务已启动');
}

function createWindow() {
    mainWindow = new BrowserWindow({
        width: 1400,
        height: 900,
        icon: path.join(__dirname, 'icon.ico'),
        webPreferences: {
            nodeIntegration: false,
            contextIsolation: true,
            preload: path.join(__dirname, 'preload.js')
        }
    });

    // 加载前端
    const indexPath = path.join(__dirname, 'client', 'build', 'index.html');
    mainWindow.loadFile(indexPath);
    
    // 开发模式打开控制台
    if (process.env.NODE_ENV === 'development') {
        mainWindow.webContents.openDevTools();
    }
}

app.whenReady().then(() => {
    startBackend();
    setTimeout(createWindow, 2000); // 等待后端启动
});

app.on('window-all-closed', () => {
    if (backendProcess) {
        backendProcess.kill();
    }
    app.quit();
});

// IPC: 打开数据库目录
ipcMain.handle('open-database-folder', async () => {
    const appData = app.getPath('appData');
    const dbFolder = path.join(appData, 'EPC项目管理系统', 'database');
    require('child_process').exec(`start "" "${dbFolder}"`);
});

// IPC: 备份数据库
ipcMain.handle('backup-database', async () => {
    const appData = app.getPath('appData');
    const dbPath = path.join(appData, 'EPC项目管理系统', 'database', 'epc_data.db');
    const backupPath = path.join(appData, 'EPC项目管理系统', 'backup', `epc_data_${Date.now()}.db`);
    
    const fs = require('fs');
    fs.copyFileSync(dbPath, backupPath);
    
    return { success: true, path: backupPath };
});
```

#### 2. 优化 package.json
```json
{
  "name": "epc-project-management",
  "version": "1.0.0",
  "description": "EPC项目管理系统 - 桌面版",
  "main": "main.js",
  "scripts": {
    "start": "electron .",
    "build:client": "cd client && npm run build",
    "build:backend": "echo 后端无需编译",
    "package": "electron-builder",
    "package:win": "electron-builder --win --x64"
  },
  "build": {
    "appId": "com.epc.management",
    "productName": "EPC项目管理系统",
    "directories": {
      "output": "release"
    },
    "files": [
      "main.js",
      "preload.js",
      "client/build/**/*",
      "server/**/*",
      "!server/venv/**/*",
      "icon.ico"
    ],
    "win": {
      "target": ["nsis"],
      "icon": "icon.ico"
    },
    "nsis": {
      "oneClick": false,
      "allowToChangeInstallationDirectory": true,
      "installerIcon": "icon.ico",
      "uninstallerIcon": "icon.ico",
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true
    },
    "extraResources": [
      {
        "from": "server/venv",
        "to": "server/venv",
        "filter": ["**/*"]
      }
    ]
  }
}
```

### 阶段三：数据管理功能 (1天)

#### 1. 添加数据库管理页面
```typescript
// client/src/pages/DatabaseManager.tsx
import React, { useState } from 'react';
import { Card, Button, Space, message, Descriptions, Alert } from 'antd';
import { DatabaseOutlined, FolderOpenOutlined, SaveOutlined } from '@ant-design/icons';

const DatabaseManager: React.FC = () => {
  const [dbInfo, setDbInfo] = useState<any>(null);

  const openDatabaseFolder = async () => {
    // @ts-ignore (Electron IPC)
    if (window.electronAPI) {
      await window.electronAPI.openDatabaseFolder();
      message.success('数据库文件夹已打开');
    } else {
      message.error('仅桌面版支持此功能');
    }
  };

  const backupDatabase = async () => {
    // @ts-ignore (Electron IPC)
    if (window.electronAPI) {
      const result = await window.electronAPI.backupDatabase();
      message.success(`数据库已备份至: ${result.path}`);
    }
  };

  return (
    <div style={{ padding: 24 }}>
      <Card title={<><DatabaseOutlined /> 数据库管理</>}>
        <Alert
          message="数据库位置"
          description="所有项目数据保存在本地 SQLite 数据库中，数据完全可控"
          type="info"
          showIcon
          style={{ marginBottom: 24 }}
        />

        <Descriptions bordered column={1}>
          <Descriptions.Item label="数据库类型">SQLite (本地文件)</Descriptions.Item>
          <Descriptions.Item label="存储位置">
            %APPDATA%\EPC项目管理系统\database\epc_data.db
          </Descriptions.Item>
          <Descriptions.Item label="备份位置">
            %APPDATA%\EPC项目管理系统\backup\
          </Descriptions.Item>
        </Descriptions>

        <Space style={{ marginTop: 24 }}>
          <Button 
            type="primary" 
            icon={<FolderOpenOutlined />}
            onClick={openDatabaseFolder}
          >
            打开数据库文件夹
          </Button>
          <Button 
            icon={<SaveOutlined />}
            onClick={backupDatabase}
          >
            立即备份数据库
          </Button>
        </Space>
      </Card>
    </div>
  );
};

export default DatabaseManager;
```

## 📦 打包部署流程

### 1. 准备打包
```bash
# 1. 构建前端
cd client
npm run build

# 2. 回到根目录
cd ..

# 3. 打包 Electron 应用
npm run package:win
```

### 2. 生成安装包
执行后会在 `release/` 目录生成：
- `EPC项目管理系统 Setup 1.0.0.exe` (安装程序)
- `EPC项目管理系统-1.0.0-win.zip` (绿色版)

### 3. 用户安装后的目录结构
```
C:\Program Files\EPC项目管理系统\
  ├── EPC项目管理系统.exe       # 主程序
  ├── resources\
  │   ├── client\build\          # 前端静态文件
  │   └── server\                # 后端Python代码
  └── ...

C:\Users\{用户}\AppData\Roaming\EPC项目管理系统\
  ├── database\
  │   └── epc_data.db            # 用户数据 ⭐
  ├── backup\                    # 自动备份
  └── files\documents\           # 文档附件
```

## 🔍 数据查看方式

### 方法1：系统内置管理页面
- 打开应用 → 系统管理 → 数据库管理
- 点击"打开数据库文件夹"即可看到 `epc_data.db`

### 方法2：使用 SQLite 工具
推荐工具：
1. **DB Browser for SQLite** (免费，图形界面)
   - 下载：https://sqlitebrowser.org/
   - 打开 `epc_data.db` 即可查看所有表和数据

2. **命令行**
   ```bash
   sqlite3 "%APPDATA%\EPC项目管理系统\database\epc_data.db"
   .tables  # 查看所有表
   SELECT * FROM projects;  # 查询项目数据
   ```

## 📊 数据备份与恢复

### 自动备份
- 每次应用启动时自动备份
- 保留最近30天的备份文件

### 手动备份
1. 打开应用 → 系统管理 → 数据库管理 → 立即备份
2. 或直接复制 `%APPDATA%\EPC项目管理系统\database\epc_data.db`

### 数据恢复
将备份的 `.db` 文件替换到：
`%APPDATA%\EPC项目管理系统\database\epc_data.db`

## 🎯 优势总结

### ✅ 数据完全本地化
- SQLite 单文件数据库
- 无需网络，离线可用
- 数据完全可控，可随时查看/备份

### ✅ 桌面应用体验
- 独立 .exe 安装程序
- 一键启动，无需配置
- 自带 Python 环境，无需用户安装

### ✅ 数据可视化
- 内置数据库管理界面
- 支持第三方SQLite工具查看
- 自动/手动备份机制

### ✅ 易于分发
- 单个 .exe 安装包
- 绿色版支持免安装
- 数据独立于程序，升级不丢失

## 📝 后续优化建议

1. **数据导出功能**
   - Excel 导出
   - PDF 报表生成
   - 数据归档

2. **多项目支持**
   - 项目数据库切换
   - 项目模板

3. **权限管理**
   - 多用户支持
   - 数据加密

4. **云同步（可选）**
   - 局域网数据同步
   - 可选的云备份

---

**当前系统已具备桌面化基础，执行上述方案即可完成完整的桌面应用打包！**


